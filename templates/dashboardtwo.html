{% extends 'index.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<style>
    .dashboard-card {
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
        background: white;
        border: none;
        height: 100%;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .card-primary {
        border-left: 4px solid #4e73df;
    }

    .card-success {
        border-left: 4px solid #1cc88a;
    }

    .card-info {
        border-left: 4px solid #36b9cc;
    }

    .card-warning {
        border-left: 4px solid #f6c23e;
    }

    .card-danger {
        border-left: 4px solid #e74a3b;
    }

    .icon-box {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        border-radius: 12px;
        color: white;
    }

    /* .icon-primary {
        background-color: #4e73df;
    }

    .icon-success {
        background-color: #1cc88a;
    }

    .icon-info {
        background-color: #36b9cc;
    }

    .icon-warning {
        background-color: #f6c23e;
    }

    .icon-danger {
        background-color: #e74a3b;
    } */

    .card-title {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #5a5c69;
    }

    .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2e2e2e;
    }

    .card-percentage {
        font-size: 0.8rem;
        font-weight: 600;
    }

    .percentage-positive {
        color: #1cc88a;
    }

    .percentage-negative {
        color: #e74a3b;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .recent-activity {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1.5rem;
        border-left: 1px solid #e3e6f0;
    }

    .activity-item:last-child {
        padding-bottom: 0;
        border-left: 1px solid transparent;
    }

    .activity-item::before {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        left: -6px;
        top: 0;
        background-color: #4e73df;
    }

    .activity-time {
        font-size: 0.7rem;
        color: #b7b9cc;
    }

    .progress-sm {
        height: 0.5rem;
    }

    .resource-status {
        font-size: 0.8rem;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .status-active {
        background-color: #1cc88a;
    }

    .status-warning {
        background-color: #f6c23e;
    }

    .status-critical {
        background-color: #e74a3b;
    }

    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: #4e73df;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Dashboard Overview</h4>
                <p class="text-muted">Welcome back! Here's what's happening with your inventory today.</p>
            </div>
            <div id="dashboard-status" class="mt-2">
                <div id="loading-status" class="d-none">
                    <span class="loading-spinner"></span> Loading dashboard data...
                </div>
                <div id="error-status" class="d-none text-danger">
                    <i class="bi bi-exclamation-triangle"></i> <span id="error-message"></span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="fetchDashboardData()">Retry</button>
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <!-- Summary Cards Row -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-primary">
                        <div class="d-flex align-items-center">
                            <div class="icon-box icon-primary me-3">
                                <i class="bi bi-tools"></i>
                            </div>
                            <div>
                                <div class="card-title">Component</div>
                                <div class="card-value" data-type="component">
                                    <span class="loading-spinner"></span>
                                </div>
                                <div class="card-percentage percentage-positive" data-type="component">
                                    <span class="loading-spinner"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-success">
                        <div class="d-flex align-items-center">
                            <div class="icon-box icon-success me-3">
                                <i class="bi bi-cart"></i>
                            </div>
                            <div>
                                <div class="card-title">Raw Materials</div>
                                <div class="card-value" data-type="raw_materials">
                                    <span class="loading-spinner"></span>
                                </div>
                                <div class="card-percentage percentage-positive" data-type="raw_materials">
                                    <span class="loading-spinner"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-info">
                        <div class="d-flex align-items-center">
                            <div class="icon-box icon-info me-3">
                                <i class="bi bi-cassette"></i>
                            </div>
                            <div>
                                <div class="card-title">Consumables</div>
                                <div class="card-value" data-type="consumables">
                                    <span class="loading-spinner"></span>
                                </div>
                                <div class="card-percentage percentage-negative" data-type="consumables">
                                    <span class="loading-spinner"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-warning">
                        <div class="d-flex align-items-center">
                            <div class="icon-box icon-warning me-3">
                                <i class="bi bi-box2"></i>
                            </div>
                            <div>
                                <div class="card-title">Products</div>
                                <div class="card-value" data-type="products">
                                    <span class="loading-spinner"></span>
                                </div>
                                <div class="card-percentage percentage-positive" data-type="products">
                                    <span class="loading-spinner"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-xl-8 mb-4">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title">Inventory Overview</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    This Year
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <li><a class="dropdown-item time-filter" href="#" data-range="day">Today</a></li>
                                    <li><a class="dropdown-item time-filter" href="#" data-range="week">This Week</a></li>
                                    <li><a class="dropdown-item time-filter" href="#" data-range="month">This Month</a></li>
                                    <li><a class="dropdown-item time-filter active" href="#" data-range="year">This Year</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 mb-4">
                    <div class="dashboard-card">
                        <h6 class="card-title mb-3">Inventory Distribution</h6>
                        <div class="chart-container">
                            <canvas id="inventoryPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity and Resource Status -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="dashboard-card">
                        <h6 class="card-title mb-3">Activity Log</h6>
                        <div class="recent-activity">
                            <div class="text-center py-4">
                                <span class="loading-spinner"></span> Loading activities...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="dashboard-card">
                        <h6 class="card-title mb-3">Resource Status</h6>
                        <div id="resource-status-container">
                            <div class="text-center py-4">
                                <span class="loading-spinner"></span> Loading status...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart instances
 
    let inventoryChart = null;
    let pieChart = null;
    
    // Current time filter
    let currentTimeRange = 'year';
    
    // Initialize dashboard
    fetchDashboardData();
    setupEventListeners();

    // Setup event listeners
    function setupEventListeners() {
        // Time filter dropdown
        document.querySelectorAll('.time-filter').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                currentTimeRange = this.dataset.range;
                
                // Update active state
                document.querySelectorAll('.time-filter').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                
                // Update button text
                document.getElementById('dropdownMenuButton').textContent = this.textContent;
                
                // Refresh data
                fetchDashboardData();
            });
        });
        
        // Refresh button (if you add one)
        // document.getElementById('refresh-btn').addEventListener('click', fetchDashboardData);
    }

    // Fetch all dashboard data
    async function fetchDashboardData() {
        try {
            console.log('Starting to fetch dashboard data...');
            showLoadingState(true);
            
            // Fetch all data in parallel
            const [summaryData, trendsData, distributionData, activityData, statusData] = await Promise.all([
                fetchData('/api/dashboard/summary/'),
                fetchData(`/api/dashboard/trends/?range=${currentTimeRange}`),
                fetchData('/api/dashboard/distribution/'),
                fetchData('/api/dashboard/activity/'),
                fetchData('/api/dashboard/status/')
            ]);
            
            console.log('All data fetched successfully:', {
                summary: summaryData,
                trends: trendsData,
                distribution: distributionData,
                activity: activityData,
                status: statusData
            });
            
            // Update UI
            updateSummaryCards(summaryData);
            renderTrendsChart(trendsData);
            renderDistributionChart(distributionData);
            renderActivityLogs(activityData);
            renderResourceStatus(statusData);
            
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            showError('Failed to load dashboard data. Please try again.');
            // Show fallback data or empty states
            showFallbackData();
        } finally {
            showLoadingState(false);
        }
    }

    // Generic fetch function with better error handling and timeout
    async function fetchData(url) {
        try {
            console.log(`Fetching data from: ${url}`);
            
            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timeout')), 10000); // 10 second timeout
            });
            
            // Create the fetch promise
            const fetchPromise = fetch(url);
            
            // Race between fetch and timeout
            const response = await Promise.race([fetchPromise, timeoutPromise]);
            
            console.log(`Response from ${url}:`, response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            console.log(`Data from ${url}:`, data);
            
            // Check if the response contains an error
            if (data.error) {
                throw new Error(data.error);
            }
            
            return data;
        } catch (error) {
            console.error(`Error fetching ${url}:`, error);
            throw error;
        }
    }

    // Show fallback data when APIs fail
    function showFallbackData() {
        // Show default values for summary cards
        updateCard('component', { count: 0, change_percentage: 0 });
        updateCard('raw_materials', { count: 0, change_percentage: 0 });
        updateCard('consumables', { count: 0, change_percentage: 0 });
        updateCard('products', { count: 0, change_percentage: 0 });
        
        // Show empty charts
        renderTrendsChart({ labels: [], datasets: [] });
        renderDistributionChart({ labels: [], datasets: [] });
        
        // Show empty activity and status
        renderActivityLogs([]);
        renderResourceStatus([]);
    }

    // Update summary cards with API data
    function updateSummaryCards(data) {
        updateCard('component', data.component);
        updateCard('raw_materials', data.raw_materials);
        updateCard('consumables', data.consumables);
        updateCard('products', data.products);
    }

    function updateCard(type, data) {
        const valueElement = document.querySelector(`.card-value[data-type="${type}"]`);
        const percentageElement = document.querySelector(`.card-percentage[data-type="${type}"]`);
        
        if (valueElement) valueElement.textContent = data.count || 0;
        
        if (percentageElement) {
            const isPositive = data.change_percentage >= 0;
            percentageElement.innerHTML = `
                <i class="bi bi-arrow-${isPositive ? 'up' : 'down'}"></i> 
                ${Math.abs(data.change_percentage || 0)}% from last period
            `;
            percentageElement.classList.toggle('percentage-positive', isPositive);
            percentageElement.classList.toggle('percentage-negative', !isPositive);
        }
    }

    // Render trends chart
    function renderTrendsChart(data) {
        const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
        
        // Destroy previous chart if exists
        if (inventoryChart) {
            inventoryChart.destroy();
        }
        
        inventoryChart = new Chart(inventoryCtx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets.map(dataset => ({
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: dataset.borderColor || getDefaultColor(dataset.label),
                    backgroundColor: dataset.backgroundColor || `rgba(${hexToRgb(getDefaultColor(dataset.label))}, 0.05)`,
                    tension: 0.3,
                    fill: true
                }))
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { 
                        mode: 'index', 
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += context.parsed.y;
                                return label;
                            }
                        }
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: false, 
                        ticks: { precision: 0 } 
                    } 
                }
            }
        });
    }

    // Render distribution chart
    function renderDistributionChart(data) {
        const pieCtx = document.getElementById('inventoryPieChart').getContext('2d');
        
        // Destroy previous chart if exists
        if (pieChart) {
            pieChart.destroy();
        }
        
        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.datasets[0].data,
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%',
            }
        });
    }

    // Render activity logs
    function renderActivityLogs(activities) {
        const activityContainer = document.querySelector('.recent-activity');
        
        if (activities.length === 0) {
            activityContainer.innerHTML = '<div class="text-center py-4">No recent activities found</div>';
            return;
        }
        
    activityContainer.innerHTML = activities.map(activity => {
    const contentTypeRaw = activity.content_type?.split('|')[1]?.trim() || 'item';
    const action = activity.action;

    // Compose readable title
    let actionTitle = '';
    if (action === 'create') {
        actionTitle = `${contentTypeRaw} added`;
    } else if (action === 'delete') {
        actionTitle = `${contentTypeRaw} deleted`;
    } else if (action === 'update') {
        actionTitle = `${contentTypeRaw} updated`;
    } else {
        actionTitle = `${contentTypeRaw} ${action}`;
    }

    const timestamp = new Date(activity.timestamp).toLocaleString();

    return `
        <div class="activity-item border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${actionTitle}</strong><br>
                    <small class="text-muted">By ${activity.user}</small><br>
                </div>
                <span class="activity-time text-muted" style="white-space: nowrap;">${timestamp}</span>
            </div>
            ${activity.details ? `
                <div class="mt-2">
                    <strong>Details:</strong>
                    <p class="mb-0">${activity.details}</p>
                </div>
            ` : ''}
        </div>
    `;
}).join('');






        
    }

    // Render resource status
    function renderResourceStatus(statusData) {
        const container = document.getElementById('resource-status-container');
        
        if (!statusData || statusData.length === 0) {
            container.innerHTML = '<div class="text-center py-4">No status data available</div>';
            return;
        }
        
        container.innerHTML = statusData.map(status => {
            const statusClass = {
                'active': 'status-active',
                'warning': 'status-warning',
                'critical': 'status-critical'
            }[status.status] || 'status-active';
            
            const progressClass = {
                'active': 'bg-success',
                'warning': 'bg-warning',
                'critical': 'bg-danger'
            }[status.status] || 'bg-success';
            
            const percentage = Math.round(status.percentage || 0);
            const value = status.value || 0;
            const total = status.total || 0;
            
            return `
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="resource-status">
                            <span class="status-indicator ${statusClass}"></span>
                            ${status.label || 'Resource'}
                        </span>
                        <span>${value}/${total} (${percentage}%)</span>
                    </div>
                    <div class="progress progress-sm">
                        <div class="progress-bar ${progressClass}" role="progressbar" 
                             style="width: ${percentage}%" 
                             aria-valuenow="${percentage}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Helper function to get default color based on label
    function getDefaultColor(label) {
        const colors = {
            'Component': '#4e73df',
            'Raw Materials': '#1cc88a',
            'Consumables': '#36b9cc',
            'Products': '#f6c23e',
            'Components': '#e74a3b'
        };
        return colors[label] || '#4e73df';
    }

    // Helper function to convert hex to rgb
    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `${r}, ${g}, ${b}`;
    }

    // Show/hide loading state
    function showLoadingState(show) {
        const loadingStatus = document.getElementById('loading-status');
        const errorStatus = document.getElementById('error-status');
        
        if (show) {
            loadingStatus.classList.remove('d-none');
            errorStatus.classList.add('d-none');
        } else {
            loadingStatus.classList.add('d-none');
        }
        
        // Also show/hide individual loading spinners
        document.querySelectorAll('.loading-spinner').forEach(el => {
            el.style.display = show ? 'inline-block' : 'none';
        });
    }

    // Show error message
    function showError(message) {
        const errorStatus = document.getElementById('error-status');
        const errorMessage = document.getElementById('error-message');
        const loadingStatus = document.getElementById('loading-status');
        
        errorMessage.textContent = message;
        errorStatus.classList.remove('d-none');
        loadingStatus.classList.add('d-none');
        
        console.error(message);
    }
});
</script>
{% endblock %}