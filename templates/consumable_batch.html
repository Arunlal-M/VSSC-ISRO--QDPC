{% extends 'index.html' %}
{% block content %}
{% load static %}

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Add Batch</h4>
                <h6>Create new Batch</h6>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Batch ID <span class="text-danger">*</span></label>
                            <input type="text" id="batch-id" name="batch-id" class="form-control" required>
                            <div class="invalid-feedback">Batch ID is required.</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label for="procurement_date">Procurement Date <span class="text-danger">*</span></label>
                            <input type="date" id="procurement_date" name="procurement_date" class="form-control" required>
                            <div class="invalid-feedback">Procurement date is required.</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Consumable <span class="text-danger">*</span></label>
							<select id="consumable" name="consumable"  class="form-control" required>
                                <option value="">Select a Consumable</option>
								{% for con in consumables %}
									<option value="{{ con.id }}">{{ con.name }}</option>
								{% endfor %}
							</select>
                            <div class="invalid-feedback">Please select a consumable.</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Batch Size <span class="text-danger">*</span></label>
                            <input type="number" name="batch_size_value" id="batch_size_value" class="form-control" min="0" step="0.01" required>
                            <div class="invalid-feedback">Batch size must be a positive number.</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Unit <span class="text-danger">*</span></label>
                            <select class="select" id="batch_size_unit" name="batch_size_unit" required>
                                <option value="">Select a Unit</option>
                                {% for unit in units %}
                                <option value="{{ unit.id }}">{{ unit.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a unit.</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Packing Details <span class="text-danger">*</span></label>
                            <input type="text" name="packing_details" id="packing_details" class="form-control" required>
                            <div class="invalid-feedback">Packing details are required.</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="date" id="expiry_date" name="expiry_date" class="form-control">
                            <div class="invalid-feedback">Expiry date must be after procurement date.</div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 col-12">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="date" id="expiry_date" name="expiry_date" class="form-control" >
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <button id="submitButton" class="btn btn-submit me-2">
                            <span class="btn-text">Submit</span>
                            <span class="btn-loading" style="display: none;">
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...
                            </span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recents" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test List</h5>
                <button type="button" class="close" id="modal-close-btn" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="tabs-sets">
                    <div class="tab-content" id="tab-content">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Real-time validation for batch size
        $('#batch_size_value').on('input', function() {
            var value = parseFloat($(this).val());
            if (value <= 0) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').show();
            } else {
                $(this).removeClass('is-invalid');
                $(this).siblings('.invalid-feedback').hide();
            }
        });
        
        // Real-time validation for expiry date
        $('#expiry_date').on('change', function() {
            var procurementDate = $('#procurement_date').val();
            var expiryDate = $(this).val();
            
            if (expiryDate && procurementDate && new Date(expiryDate) <= new Date(procurementDate)) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').show();
            } else {
                $(this).removeClass('is-invalid');
                $(this).siblings('.invalid-feedback').hide();
            }
        });
        
        // Real-time validation for procurement date
        $('#procurement_date').on('change', function() {
            var expiryDate = $('#expiry_date').val();
            var procurementDate = $(this).val();
            
            if (expiryDate && procurementDate && new Date(expiryDate) <= new Date(procurementDate)) {
                $('#expiry_date').addClass('is-invalid');
                $('#expiry_date').siblings('.invalid-feedback').show();
            } else {
                $('#expiry_date').removeClass('is-invalid');
                $('#expiry_date').siblings('.invalid-feedback').hide();
            }
        });
        
        $('#consumable').on('change', function () {
            var selectedValue = $(this).val();
            if (selectedValue) {
                $.ajax({
                    url: `/consumable/consumable-list/${selectedValue}/`,
                    type: 'GET',
                    success: function (response) {
                        var consumableData = response.data;
                        console.log(response.data)

                        // Calculate Expiry Date
                        var procurementDate = $('#procurement_date').val(); 
                        var shelfLifeValue = consumableData.shelf_life_value;
                        var shelfLifeUnit = consumableData.shelf_life_unit;
                        var expiryDate = null;

                        // ‚úÖ Calculate Expiry Date if procurement date is available
                        if (procurementDate && shelfLifeValue && shelfLifeUnit) {
                            expiryDate = calculateExpiryDate(procurementDate, shelfLifeValue, shelfLifeUnit);
                            $('#expiry_date').val(expiryDate);
                            
                            // Show success message for auto-calculation
                            if (shelfLifeValue && shelfLifeUnit) {
                                showSwalAlert(`üìÖ Expiry date automatically calculated: ${expiryDate} (${shelfLifeValue} ${shelfLifeUnit} from procurement date)`, 'success');
                            }
                        } else if (shelfLifeValue && shelfLifeUnit) {
                            showSwalAlert('‚ö†Ô∏è Please set procurement date to automatically calculate expiry date', 'warning');
                        }

                        var acceptanceTests = consumableData.acceptance_test;
                        var tabContent = $('#tab-content');
                        tabContent.empty().hide();

                        // Fill the Batch ID Field
                        var batchId = $('#batch-id').val(); // Assuming the API returns a batch_id
                        $('#batch-id').val(batchId);
                        $('#batch-id').siblings('.text-danger').remove();

                        if (!batchId) {
                            $('#batch-id').addClass('is-invalid'); // Add a class for styling if needed
                            $('#batch-id').after('<span class="text-danger">Please fill in the Batch ID</span>');
                            $('#recents').modal('hide');
                        } else {
                            $('#batch-id').removeClass('is-invalid'); // Remove validation if value is present
                            $('#batch-id').siblings('.text-danger').remove();
                            $('#recents').modal('show');
                            // Remove any previous message

                            // Populate tabContent if batchId is present
                            tabContent.show(); // Show tabContent only when Batch ID is valid

                            var source = consumableData.sources;
                            var suppliers = consumableData.suppliers;
                            var grade = consumableData.grade;

                            // Start building the new content
                            var newContent = `
                        <div class="row mb-3 align-items-center border-bottom">
                            <div class="col-lg-3 col-sm-6 col-12">
                                <div class="form-group">
                                    <label>Batch ID</label>
                                    <input type="text" class="form-control" id="batch-id" value="${batchId}" placeholder="Enter Batch ID" readonly>
                                </div>
                            </div>

                            <div class="col-lg-3 col-sm-6 col-12">
                                <div class="form-group">
                                    <label>Source</label>
                                    <select class="form-control" id="source-dropdown">
                                        <option value="">Select a Source</option>`;
                            // Loop through sources to create option elements
                            source.forEach(function (source) {
                                newContent += `<option value="${source.id}">${source.name}</option>`;
                            });

                            // Close the select element and continue with the rest of the form
                            newContent += `
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-3 col-sm-6 col-12">
                                <div class="form-group">
                                    <label>Supplier</label>
                                    <select class="form-control" id="supplier-dropdown">
                                        <option value="">Select a Supplier</option>`;
                            // Loop through suppliers to create option elements
                            suppliers.forEach(function (suppliers) {
                                newContent += `<option value="${suppliers.id}">${suppliers.name}</option>`;
                            });

                            // Close the select element and continue with the rest of the form
                            newContent += `
                                    </select>
                                </div>
                            </div>

                    <div class="col-lg-3 col-sm-6 col-12">
                                <div class="form-group">
                                    <label>Grade</label>
                                    <select class="form-control" id="grade-dropdown">
                                        <option value="">Select a Grade</option>`;

                            // Loop through suppliers to create option elements
                            grade.forEach(function (grade) {
                                newContent += `<option value="${grade.id}">${grade.name}</option>`;
                            });

                            // Close the select element and continue with the rest of the form
                            newContent += `
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;

                          //  acceptanceTests.forEach((test) => {
                              //  newContent += `
                           // <div class="row mb-3 align-items-center border-bottom">
                             //  <div class="col-lg-2 col-sm-6 col-12 p-2">
                               //     <div class="form-group">
                                 //       <label>Specification</label>
                                   //     <input type="text" id="specification-value-${test.id}" value="${test.min}-${test.max}" placeholder="Enter specification" class="form-control" readonly>
                                    //</div>
                                //</div>
                                //<div class="col-lg-2 col-sm-6 col-12 p-2">
                                  //  <div class="form-group">
                                    //    <label>${test.name}</label>
                                      //  <input type="number" id="test-value-${test.id}" placeholder="Enter test value" class="form-control">
                                    //</div>
                                //</div>
                               // <div class="col-lg-2 col-sm-6 col-12 p-2">
                                   // <div class="form-group">
                                      //  <label>Unit</label>
                                      //  <input type="text" id="unit-${test.id}" value="${test.unit}" placeholder="Enter unit" class="form-control">
                                 //   </div>
                               // </div>
                               // <div class="col-lg-2 col-sm-6 col-12 p-2">
                                  //  <div class="form-group">
                                   //     <label>Status</label>
                                       // <select class="form-control" id="status-${test.id}" style="background-color: green; color: white;">
                                       //     <option value="Valid">Specification Met</option>
                                        //    <option value="Invalid">Specification Not Met</option>
                                       // </select>
                                  //  </div>
                                //</div>
                               // <div class="col-lg-2 col-sm-6 col-12 p-2">
                                  //  <div class="form-group">
                                  //      <label>Remark</label>
                                    //    <input type="text" id="remark-${test.id}" placeholder="Enter remark" class="form-control">
                                 //   </div>
                             //   </div>
                               // <div class="col-lg-2 col-sm-6 col-12 p-2">
                                  //  <div class="form-group">
                                    //    <label>File</label>
                                    //    <input type="file" class="form-control mt-2" id="file-${test.id}">
                             //       </div>
                             //   </div>
                         //   </div>
                       // `;

                            // Add event listener to check if test value is within the min and max range
                           // $(document).on('input', `#test-value-${test.id}`, function () {
                             //   var enteredValue = parseFloat($(this).val());

                               // var min = parseFloat(test.min);
                               // var max = parseFloat(test.max);
                                //var statusDropdown = $(`#status-${test.id}`);

                                // Automatically select status based on entered value
                              //  if (enteredValue >= min && enteredValue <= max) {
                                  //  statusDropdown.val("Valid");
                                //    statusDropdown.css("background-color", "green");
                               //     statusDropdown.css("color", "white");
                               // } else {
                               //     statusDropdown.val("Invalid");
                             //       statusDropdown.css("background-color", "red");
                                //    statusDropdown.css("color", "white");
                              //  }
                           // });

                        //});



                                $(document).on('change', '#grade-dropdown', function () {
                                const selectedGradeName = $(this).find('option:selected').text();
                                const consumableName = $('#consumable option:selected').text();

                                if (!selectedGradeName || !consumableName) {
                                    alert('Please select a valid grade and consumable.');
                                    return;
                                }

                                $.ajax({
                                    url: '{% url "consumable-batch-add" %}',
                                    type: 'GET',
                                    data: {
                                        grade_name: selectedGradeName,
                                        consumable_name: consumableName
                                    },
                                    success: function (response) {
                                        const acceptanceTests = response.tests;

                                        const tabContent = $('#tab-content');
                                        const testBlockId = `grade-test-block-${selectedGradeName}`;
                                        const newTestBlock = $(`<div id="${testBlockId}" class="grade-test-block"></div>`);

                                        // ‚úÖ Clear previous test block
                                        $('.grade-test-block').remove();

                                        // ‚úÖ Generate content for this grade
                                        acceptanceTests.forEach((test) => {
                                            const testHtml = `
                    <div class="row mb-3 align-items-center border-bottom">
                        <div class="col-lg-2 col-sm-6 col-12 p-2">
                            <label>Specification</label>
                            <input type="text" id="specification-value-${test.id}" value="${test.min}-${test.max}" class="form-control" readonly>
                        </div>
                        <div class="col-lg-2 col-sm-6 col-12 p-2">
                            <label>${test.name}</label>
                            <input type="number" id="test-value-${test.id}" class="form-control" placeholder="Enter test value">
                        </div>
                        <div class="col-lg-2 col-sm-6 col-12 p-2">
                            <label>Unit</label>
                            <input type="text" id="unit-${test.id}" value="${test.unit}" class="form-control" readonly>
                        </div>
                        <div class="col-lg-2 col-sm-6 col-12 p-2">
                            <label>Status</label>
                            <select class="form-control" id="status-${test.id}">
                                <option value="Valid">Specification Met</option>
                                <option value="Invalid">Specification Not Met</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-sm-6 col-12 p-2">
                            <label>Remark</label>
                            <input type="text" id="remark-${test.id}" class="form-control" placeholder="Enter remark">
                        </div>
                        <div class="col-lg-2 col-sm-6 col-12 p-2">
                            <label>File</label>
                            <input type="file" class="form-control mt-2" id="file-${test.id}">
                        </div>
                    </div>
                `;

                                            newTestBlock.append(testHtml);

                                            // ‚úÖ Bind value checker
                                            $(document).off('input', `#test-value-${test.id}`).on('input', `#test-value-${test.id}`, function () {
                                                const val = parseFloat($(this).val());
                                                const min = parseFloat(test.min);
                                                const max = parseFloat(test.max);
                                                const status = $(`#status-${test.id}`);

                                                if (!isNaN(val) && val >= min && val <= max) {
                                                    status.val("Valid").css({ backgroundColor: "green", color: "white" });
                                                } else {
                                                    status.val("Invalid").css({ backgroundColor: "red", color: "white" });
                                                }
                                            });
                                        });

                                        // ‚úÖ Append the new block and ensure visibility
                                        tabContent.append(newTestBlock).show();
                                    },
                                    error: function () {
                                        alert('Failed to fetch acceptance tests.');
                                    }
                                });
                            });



                            
                            newContent += `
                        <div class="row">
                            <div class="col-lg-4 col-sm-6 col-12">
                                <div class="form-group">
                                    <button id="submit-all-tests" class="btn btn-submit me-2">Submit All</button>
                                </div>
                            </div>
                        </div>
                    `;

                            tabContent.append(newContent);
                        }
                        $('#submit-all-tests').off('click').on('click', function () {
                            var formData = new FormData();
                            formData.append('consumable', selectedValue);
                            formData.append('batch_id', batchId);
                            formData.append('expiry_date', expiryDate);//  expiry date in submission
                        
                            // Loop through each acceptance test and append its data to FormData
                            acceptanceTests.forEach((test, index) => {
                                formData.append(`acceptance_tests[${index}][id]`, test.id);
                                formData.append(`acceptance_tests[${index}][test_value]`, $(`#test-value-${test.id}`).val());
                                formData.append(`acceptance_tests[${index}][min_value]`, parseInt($(`#specification-value-${test.id}`).val().split('-')[0], 10));
                                formData.append(`acceptance_tests[${index}][max_value]`, parseInt($(`#specification-value-${test.id}`).val().split('-')[1], 10));
                                formData.append(`acceptance_tests[${index}][status]`, $(`#status-${test.id}`).val());
                                formData.append(`acceptance_tests[${index}][remark]`, $(`#remark-${test.id}`).val());
                                formData.append(`acceptance_tests[${index}][created_by]`, 'user');
                        
                                // Append the file directly (if a file is selected)
                                var fileInput = $(`#file-${test.id}`)[0].files[0];
                                if (fileInput) {
                                    formData.append(`acceptance_tests[${index}][file]`, fileInput);
                                }
                            });
                        
                            // Append additional fields for source, supplier, and grade
                            formData.append('sources', $('#source-dropdown').val());
                            formData.append('suppliers', $('#supplier-dropdown').val());
                            formData.append('grade', $('#grade-dropdown').val());
                        
                            // AJAX request to send FormData to the server
                            $.ajax({
                                url: '{% url "consumable-batch-test-add" %}',
                                type: 'POST',
                                data: formData,
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                processData: false,
                                contentType: false,
                                success: function (response) {
                                    showSwalAlert('üìÑ Files and test values submitted successfully!', 'success');
                                    $('#modal-close-btn').click();
                                },
                                error: function (error) {
                                    showSwalAlert('‚ùå Error submitting test data. Please try again.', 'error');
                                    console.log('Error submitting data:', error);
                                }
                            });
                        });
                        
                        
                    },
                    error: function (error) {
                        showSwalAlert('‚ùå Error fetching consumable data. Please try again.', 'error');
                        console.log('Error fetching data:', error);
                    }
                });
            }
        });
    });

            $(document).ready(function() {
        $('#submitButton').click(function(event) {
            event.preventDefault();
            
            // Clear previous error messages and validation states
            $('.error-message').remove();
            $('.form-control').removeClass('is-invalid');
            $('.invalid-feedback').hide();
            
            // Validate required fields
            var isValid = true;
            var requiredFields = ['batch-id', 'procurement_date', 'consumable', 'batch_size_value', 'batch_size_unit', 'packing_details'];
            
            requiredFields.forEach(function(fieldId) {
                var field = $('#' + fieldId);
                if (!field.val().trim()) {
                    field.addClass('is-invalid');
                    field.siblings('.invalid-feedback').show();
                    isValid = false;
                }
            });
            
            // Validate batch size value
            var batchSizeValue = parseFloat($('#batch_size_value').val());
            if (batchSizeValue <= 0) {
                $('#batch_size_value').addClass('is-invalid');
                $('#batch_size_value').siblings('.invalid-feedback').show();
                isValid = false;
            }
            
            // Validate expiry date if provided
            var procurementDate = $('#procurement_date').val();
            var expiryDate = $('#expiry_date').val();
            if (expiryDate && procurementDate && new Date(expiryDate) <= new Date(procurementDate)) {
                $('#expiry_date').addClass('is-invalid');
                $('#expiry_date').siblings('.invalid-feedback').show();
                isValid = false;
            }
            
            if (!isValid) {
                showSwalAlert('‚ö†Ô∏è Please fill in all required fields correctly before submitting.', 'error');
                return;
            }

            // Show loading state
            $('#submitButton').prop('disabled', true);
            $('.btn-text').hide();
            $('.btn-loading').show();

            // Gather form data
            var consum = $('#consumable').val();
            var batchId = $('#batch-id').val();
            var procurementDate = $('#procurement_date').val();
            var batchSizeValue = parseFloat($('#batch_size_value').val());
            var batchSizeUnit = $('#batch_size_unit').val();
            var packingDetails = $('#packing_details').val();
            var expiryDate = $('#expiry_date').val();

            // Create FormData for proper form submission
            var formData = new FormData();
            formData.append('consumable', consum);
            formData.append('batch_id', batchId);
            formData.append('procurement_date', procurementDate);
            formData.append('batch_size_value', batchSizeValue);
            formData.append('batch_size_unit', batchSizeUnit);
            formData.append('packing_details', packingDetails);
            if (expiryDate) {
                formData.append('expiry_date', expiryDate);
            }

            console.log('Submitting consumable batch data:', {
                consumable: consum,
                batch_id: batchId,
                procurement_date: procurementDate,
                batch_size_value: batchSizeValue,
                batch_size_unit: batchSizeUnit,
                packing_details: packingDetails,
                expiry_date: expiryDate
            });

            // Send data as FormData
            $.ajax({
                type: 'POST',
                url: '{% url "consumable-batch-add" %}',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        var batchId = $('#batch-id').val();
                        showSwalAlert(`üéâ Consumable batch "${batchId}" created successfully! The batch has been added to your inventory and will redirect you to the list page.`, 'success');
                        setTimeout(function() {
                            window.location.href = "{% url 'consumable-batch-fetch' %}";
                        }, 3000);
                    } else {
                        showSwalAlert(response.message || '‚ùå Failed to create consumable batch. Please check your input and try again.', 'error');
                    }
                },
                error: function(xhr, status, error) {
                    var errorMessage = '‚ùå An error occurred while creating the consumable batch. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = '‚ùå ' + xhr.responseJSON.message;
                    }
                    showSwalAlert(errorMessage, 'error');
                },
                complete: function() {
                    // Reset button state
                    $('#submitButton').prop('disabled', false);
                    $('.btn-text').show();
                    $('.btn-loading').hide();
                }
            });
        });

        function showSwalAlert(message, type) {
            if (typeof Swal !== 'undefined') {
                var title, confirmButtonColor;
                
                switch(type) {
                    case 'success':
                        title = 'Success!';
                        confirmButtonColor = '#28a745';
                        break;
                    case 'error':
                        title = 'Error!';
                        confirmButtonColor = '#dc3545';
                        break;
                    case 'warning':
                        title = 'Warning!';
                        confirmButtonColor = '#ffc107';
                        break;
                    default:
                        title = 'Info!';
                        confirmButtonColor = '#17a2b8';
                }
                
                Swal.fire({
                    title: title,
                    text: message,
                    icon: type,
                    confirmButtonText: 'OK',
                    confirmButtonColor: confirmButtonColor,
                    timer: type === 'success' ? 3000 : undefined,
                    timerProgressBar: type === 'success' ? true : false
                });
            } else {
                // Fallback to regular alert if SweetAlert is not loaded
                var alertClass;
                switch(type) {
                    case 'success':
                        alertClass = 'alert-success';
                        break;
                    case 'error':
                        alertClass = 'alert-danger';
                        break;
                    case 'warning':
                        alertClass = 'alert-warning';
                        break;
                    default:
                        alertClass = 'alert-info';
                }
                
                var alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('.page-header').after(alertHtml);
            }
        }
        
        function clearForm() {
            // Clear all form fields
            $('#batch-id').val('').removeClass('is-invalid');
            $('#procurement_date').val('').removeClass('is-invalid');
            $('#consumable').val('').removeClass('is-invalid');
            $('#batch_size_value').val('').removeClass('is-invalid');
            $('#batch_size_unit').val('').removeClass('is-invalid');
            $('#packing_details').val('').removeClass('is-invalid');
            $('#expiry_date').val('').removeClass('is-invalid');
            
            // Hide all validation messages
            $('.invalid-feedback').hide();
            $('.error-message').remove();
            
            // Reset button state
            $('#submitButton').prop('disabled', false);
            $('.btn-text').show();
            $('.btn-loading').hide();
            
            // Show success message
            showSwalAlert('‚úÖ Form cleared successfully!', 'success');
        }
    });

//  Function to calculate expiry date

    function calculateExpiryDate(procurementDate, shelfLifeValue, shelfLifeUnit) {
    var date = new Date(procurementDate);

    if (shelfLifeUnit === 'days') {
        date.setDate(date.getDate() + shelfLifeValue);
    } else if (shelfLifeUnit === 'months') {
        date.setMonth(date.getMonth() + shelfLifeValue);
    } else if (shelfLifeUnit === 'years') {
        date.setFullYear(date.getFullYear() + shelfLifeValue);
    }

    return date.toISOString().split('T')[0];  // Return formatted date (YYYY-MM-DD)
}


</script>


<style>
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control, .select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus, .select:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .form-control.is-invalid, .select.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .btn-submit {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
    }

    .btn-submit:hover {
        background-color: #218838;
        border-color: #1e7e34;
        color: white;
    }

    .btn-submit:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
    }
    
    .btn-loading {
        display: none;
    }
    
    .btn-submit:disabled .btn-loading {
        display: inline-block;
    }
    
    .btn-submit:disabled .btn-text {
        display: none;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .page-title h4 {
        color: #333;
        font-weight: 600;
    }

    .page-title h6 {
        color: #6c757d;
        font-weight: 400;
    }

    label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    /* Alert styling */
    .alert {
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Modal styling */
    .modal-dialog {
        max-width: 1250px;
        margin-left: 290px;
    }

    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        color: #495057;
        font-weight: 600;
    }

    /* Form validation styling */
    .is-invalid {
        border-color: #dc3545 !important;
    }

    .text-danger {
        color: #dc3545 !important;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .modal-dialog {
            max-width: 90%;
            margin-left: 5%;
        }
    }
</style>

{% endblock %}