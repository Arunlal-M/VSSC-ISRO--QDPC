{% extends 'index.html' %}
{% block content %}
{% load static %}
	
			<div class="page-wrapper">
				<div class="content">
					<div class="page-header">
						<div class="page-title">
							<h4>Component Batch</h4>
							<!-- <h6>Manage your products</h6> -->
						</div>
						<div class="page-btn">
							<a href="{% url 'component-batch-add' %}" class="btn btn-added"><img src="{% static 'assets/img/icons/plus.svg' %}" alt="img" class="me-1">Add Batch</a>
						</div>
					</div>
					

					<!-- /product list -->
					<div class="card">
						<div class="card-body">
							<div class="table-top">
								<div class="search-set">
									<div class="search-path">
										<a class="btn btn-filter" id="filter_search">
											<img src="{% static 'assets/img/icons/filter.svg' %}" alt="img">
											<span><img src="{% static 'assets/img/icons/closes.svg' %}" alt="img"></span>
										</a>
									</div>
									<div class="search-input">
										<a class="btn btn-searchset"><img src="{% static 'assets/img/icons/search-white.svg' %}" alt="img"></a>
									</div>
								</div>
								<div class="wordset">
									<ul>
										<li>
											<a data-bs-toggle="tooltip" data-bs-placement="top" title="pdf"><img src="{% static 'assets/img/icons/pdf.svg' %}" alt="img"></a>
										</li>
										<li>
											<a data-bs-toggle="tooltip" data-bs-placement="top" title="excel"><img src="{% static 'assets/img/icons/excel.svg' %}" alt="img"></a>
										</li>
										<li>
											<a data-bs-toggle="tooltip" data-bs-placement="top" title="print"><img src="{% static 'assets/img/icons/printer.svg' %}" alt="img"></a>
										</li>
									</ul>
								</div>
							</div>

							<div class="table-responsive">
								<table class="table datanew table-striped table-hover text-center table-bordered">
									<thead>
										<tr>
											<th>Component</th>
											<th>Batch Id</th>
											<th>Batch Size</th>
											<th>Procurement / Manufacturing Date</th>
											<th>Packing Detials</th>
											<th>Expiry Date</th>
											<th>Status</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
										{% for batch in batches %}
										<tr>
											<td data-batch-id="{{ batch.batch_id }}">{{ batch.component_name }}</td>
											<td data-batch-id="{{ batch.batch_id }}">{{ batch.batch_id }}</td>
											<td data-batch-id="{{ batch.batch_id }}">{{ batch.batch_size_value }} {{ batch.unit_name }}</td>
											<td data-batch-id="{{ batch.batch_id }}">{{ batch.procurement_date }}</td>
               							    <td data-batch-id="{{ batch.batch_id }}">{{ batch.packing_details }}</td>
											<td data-batch-id="{{ batch.batch_id }}">{{ batch.expiry_date }}</td>
               							    <td data-batch-id="{{ batch.batch_id }}">{{ batch.status}}</td>
											<td>
												<!-- <a class="me-3" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#materialpage">
													<img src="{% static 'assets/img/icons/eye.svg' %}" alt="img">
												</a> -->
												<a class="me-3 view-user-btn" data-bs-toggle="modal"
												data-bs-target="#componentbatchpage" data-batch-id="{{ batch.batch_id }}">
												<img src="{% static 'assets/img/icons/edit.svg' %}" alt="img">
												</a>
												<a id="delete-btn" data-id="{{ batch.batch_id }}">
													<img src="{% static 'assets/img/icons/delete.svg' %}" alt="img">
												</a>
											</td>
										</tr>
										{% empty %}
									{% endfor %}
										
									
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<!-- /product list -->
				</div>
			</div>
        </div>
		<!-- /Main Wrapper -->

        <div class="modal fade" id="materialpage" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Component Batch</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                    </div>
                    <div class="modal-body">
                        <div class="container mt-5">
                           
                            <!-- <form>
                                <div class="mb-3">
                                    <label for="username" class="form-label">User Name</label>
                                    <input type="text" class="form-control" id="username" placeholder="Enter User Name">
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="text" class="form-control" id="phone" placeholder="Enter Phone">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" placeholder="Enter Email">
                                </div>
                                <div class="mb-3">
                                    <label for="role" class="form-label">Role</label>
                                    <select class="form-select" id="role">
                                        <option>Select Role</option>
                                        <option>Admin</option>
                                        <option>User</option>
                                        <option>Guest</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="createdOn" class="form-label">Created On</label>
                                    <input type="date" class="form-control" id="createdOn">
                                </div>
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status">
                                        <option>Select Status</option>
                                        <option>Active</option>
                                        <option>Inactive</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Update</button>
                            </form> -->
                            <div class="mb-3">
                                <label for="username" class="form-label">Component</label>
                                <div id="username" class="form-control">Pink oxide</div>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Batch Id</label>
                                <div id="phone" class="form-control">12345745</div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Batch Size</label>
                                <div id="email" class="form-control">25 kg</div>
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">Expiry Date</label>
                                <div id="role" class="form-control">2024-08-08</div>
                            </div>
                            <div class="mb-3">
                                <label for="createdOn" class="form-label">Packing Detials</label>
                                <div id="createdOn" class="form-control">2024-08-08</div>
                            </div>
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <div id="status" class="form-control">Active</div>
                            </div>
                            
                        </div>
                    </div>
                    <!-- <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div> -->
                </div>
            </div>
        </div>
		
		<!-- edit div -->
		<div class="modal fade" id="componentbatchpage" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">Component Batch View</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
					</div>
					<div class="modal-body">
						<div class="container mt-2">
							<form class="row">
								<div class="col-6 mt-2">
									<label>Batch ID</label>
									<input type="text" id="batch-id" name="batch-id" class="form-control" readonly>
								</div>

								<div class="col-6 mt-2">
									<label for="component" class="form-label">Component</label>
									<input type="text" class="form-control" id="component" name="component"
										placeholder="Component" readonly>
								</div>

								<div class="col-6 mt-2">
									<label for="procurement_date">Procurement/Manufacturing Date</label>
									<input type="date" id="procurement_date" name="procurement_date" class="form-control">
								</div>

								<div class="col-6 mt-2">
									<label for="batch_size" class="form-label">Batch Size</label>
									<input type="text" name="batch_size" id="batch_size" class="form-control">
								</div>
								<div class="col-6 mt-2">
									<label for="packing_details" class="form-label">Packing Details</label>
									<input type="text" name="packing_details" id="packing_details" class="form-control">
								</div>
								<!-- <div class="col-6 mt-2">
									<label for="created_on" class="form-label">Created On</label>
									<input type="text" name="created_on" id="created_on" class="form-control">
								</div>
								<div class="col-6 mt-2">
									<label for="created_by" class="form-label">Created By</label>
									<input type="text" name="created_by" id="created_by" class="form-control">
								</div> -->
								<div class="col-6 mt-2">
									<label for="edit-status" class="form-label">Status</label>
									<select name="status" id="edit-status" class="form-control">
										<option value="available">Available</option>
										<option value="exhausted">Exhausted</option>
									</select>
								</div>

								<div class="d-flex justify-content-center mt-3">
									<button type="button" class="btn btn-primary btn-sm"
										id="updateComponentBatch">Update</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
<!-- DELTE CONFIRMATION MODAL -->
<div id="confirmDeleteModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center ">
                <p>Are you sure you want to delete this Coomponent?</p>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-danger text-right" id="confirm-delete">Delete</button>
                <button type="button" class="btn btn-secondary text-right" id="cancel-delete"
                    data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', function () {
		document.querySelectorAll('td[data-batch-id]').forEach(function (statusField) {
			const status = statusField.textContent.trim().toLowerCase();
			if (status === 'available') {
				statusField.style.backgroundColor = 'green';
				statusField.style.color = 'white';
				statusField.textContent = 'Available';
			} else if (status === 'exhausted') {
				statusField.style.backgroundColor = 'red';
				statusField.style.color = 'white';
				statusField.textContent = 'Exhausted';
			}
		});
	});

	$('.view-user-btn').on('click', function () {
		$('#saveUserChanges').show();
		const baseUrl = '/component/component-batch-fetch/edit/';
		const batchId = $(this).data('batch-id');
		let encodedbatchId = encodeURIComponent(batchId); // Encode special characters
		const componentbatchUpdateUrl = `${baseUrl}${encodedbatchId}/`;
		console.log('Component batch update URL:', componentbatchUpdateUrl);

		$.ajax({
			type: 'GET',
			url: componentbatchUpdateUrl,
			success: function (response) {
				const compbatchData = response.data;
				console.log('Consumable batch data:', compbatchData);

				$('#batch-id').val(compbatchData.batch_id);
				$('#component').val(compbatchData.component_name);
				$('#procurement_date').val(compbatchData.procurement_date);
				$('#batch_size').val(compbatchData.batch_size_value);
				$('#packing_details').val(compbatchData.packing_details);
				// $('#created_on').val(compbatchData.shelf_life_value);
				// $('#created_by').val(compbatchData.shelf_life_unit);
				$('#edit-status').val(compbatchData.status);


				$('#componentbatchpage').modal('show');
			},
			error: function (error) {
				console.error('Failed to fetch component batch data:', error);
			}
		});



	$(document).ready(function () {
		$('#updateComponentBatch').click(function (event) {
			event.preventDefault();

			// Collect data from the form
			const updatedData = {
				batchId: $('#batch-id').val(),
				component_name: $('#component').val(),
				procurement_date: $('#procurement_date').val(),
				batch_size_value: parseFloat($('#batch_size').val()),
				packing_details: $('#packing_details').val(),
				status: $('#edit-status').val()
			};
			console.log('Updated Component batch data:', updatedData);

			// Send PUT request
			$.ajax({
				type: 'PUT',
				url: '/component/component-batch-fetch/edit/' + encodedbatchId + '/',
				data: JSON.stringify(updatedData),
				contentType: 'application/json',
				headers: {
					'X-CSRFToken': '{{ csrf_token }}'
				},
				success: function (response) {
					if (response.isSuccess) {
						console.log('Update successful. Redirecting...');
						location.reload(); // Reload the page to reflect changes
					} else {
						$('#error-message').text(response.message).show();
					}
				},
				error: function (error) {
					$('#error-message').text('An error occurred. Please try again.').show();
				}
			});
		});
	});
});


$(document).on('click', '#delete-btn', function (e) {
        e.preventDefault(); // Prevent default link behavior

        var combatchId = $(this).data('id'); // Get Component Batch ID from data attribute
        if (!combatchId) {
            alert('Component Batch ID not found.');
            return;
        }

        // Store the Component Batch ID in the modal's confirm button for reference
        $('#confirm-delete').data('id', combatchId);

        // Show the confirmation modal
        $('#confirmDeleteModal').modal('show');
    });

    // Handle the confirmation of deletion
    $(document).on('click', '#confirm-delete', function () {
        var combatchId = $(this).data('id'); // Retrieve Component Batch ID from the modal's confirm button
        let encodedCombatchId = encodeURIComponent(combatchId); // Encode special characters

        if (!combatchId) {
            alert('Component Batch ID not found.');
            return;
        }

        // Construct the URL dynamically
        const baseUrl = "/component/combatch-list/delete/";
        const deleteUrl = `${baseUrl}${encodedCombatchId}/`;

        // Perform the AJAX request for deletion
        $.ajax({
            url: deleteUrl,
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}', // Add CSRF token header
            },
            success: function (response) {
                if (response.success) {
                    console.log('Delete successful, reloading page...');

                    // Close the modal after success
                    $('#confirmDeleteModal').modal('hide');

                    // Reload the page immediately after successful deletion
                    window.location.reload(true); // Force reload (bypass cache)
                } else {
                    alert('Error: ' + response.message);
                    console.error('Delete failed: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                alert('An error occurred: ' + error);
                console.error('AJAX error:', error);
            }
        });
    });

    // Handle the cancel button to close the modal
    $(document).on('click', '#cancel-delete, .close', function () {
        $('#confirmDeleteModal').modal('hide'); // Explicitly hide the modal on cancel
    });

</script>
        {% endblock %}