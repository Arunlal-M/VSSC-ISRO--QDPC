{% extends 'index.html' %}
{% block content %}
{% load static %}

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Add Consumable</h4>
                <h6>Consumable Configuration</h6>
            </div>
        </div>
        <!-- /add -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label>Consumable</label>
                            <input type="text" name="consumable" id="consumable">
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="supplier" class="form-label">Suppliers</label>
                        <select class="select" id="supplier" name="supplier[]" multiple>
                            {% for sup in suppliers %}
                            <option value="{{ sup.id }}">{{ sup.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="sources" class="form-label">Sources</label>
                        <select class="select" id="sources" name="sources[]" multiple>
                            {% for sour in sources %}
                            <option value="{{ sour.id }}">{{ sour.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="precertified" class="form-label">Pre-Certified</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="precertified" name="precertified">
                                <label class="form-check-label" for="precertified">Check if Pre-Certified</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="acceptance_test" class="form-label">Acceptance Test</label>
                        <select class="select" id="acceptance_test" name="acceptance_test" multiple
                            onchange="handleSelection()">
                            {% for acc in acceptence_test %}
                            <option value="{{ acc.id }}">{{ acc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="grade">Grade</label>
                            <select class="select" id="grade" name="grade" multiple onchange="handleSelection()">
                                {% for grade in grades %}
                                <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="shelf_life_type">Shelf Life</label>
                            <select id="shelf_life_type" name="shelf_life_type" class="form-control">
                                <option value="">Choose Type</option>
                                <option value="tbd">TBD (To Be Decided)</option>
                                <option value="not_applicable">Not Applicable</option>
                                <option value="add_duration">Add Duration</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4" id="shelf_life_duration_group" style="display: none;">
                        <div class="form-group">
                            <label for="shelf_life_value">Shelf Life Duration</label>
                            <input type="number" id="shelf_life_value" name="shelf_life_value" class="form-control"
                                placeholder="Enter duration">
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4" id="shelf_life_period_group" style="display: none;">
                        <div class="form-group">
                            <label for="unit">Shelf Life Period</label>
                            <select id="unit" name="unit" class="form-control">
                                <option value="days">Days</option>
                                <option value="months">Months</option>
                                <option value="years">Years</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="document_upload" class="form-label">Document Upload</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="document_upload" name="document_upload">
                                <label class="form-check-label" for="document_upload">Check to upload Document</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <button type="button" id="submitButton" class="btn btn-submit me-2">Submit</button>
                        <a href="{% url 'consumable-add' %}" class="btn btn-cancel">Clear</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- /add -->
    </div>

<div class="container mt-5">
        <h1>Acceptance Test Specifications</h1>
        <!-- Div where the table will be created dynamically -->
        <div class="content" id="acceptance_test_table">
            <!-- Table will be appended here via JavaScript -->
        </div>
    </div>
    <!-- /Main Wrapper -->

<!-- Add Document Modal -->
<div class="modal fade" id="addConsumableDocumentModal" tabindex="-1" aria-labelledby="addDocumentLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addDocumentForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDocumentLabel">Add Consumable Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <!-- Hidden field for Consumable -->
                    <input type="hidden" id="consumableField" name="consumable">

                    <!-- Title Field -->
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title"
                            placeholder="Enter document title" required>
                    </div>

                    <!-- Category Dropdown -->
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category" required>
                            <option>Choose Document Type</option>
                            {% for doc_type in document_types %}
                            <option value="{{ doc_type.id }}">{{ doc_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Issue Number Field -->
                    <div class="mb-3">
                        <label for="issue_no" class="form-label">Issue Number</label>
                        <input type="text" class="form-control" id="issue_no" name="issue_no"
                            placeholder="Enter issue number" required>
                    </div>

                    <!-- Revision Number Field -->
                    <div class="mb-3">
                        <label for="revision_no" class="form-label">Revision Number</label>
                        <input type="text" class="form-control" id="revision_no" name="revision_no"
                            placeholder="Enter revision number" required>
                    </div>

                    <!-- Release Date Field -->
                    <div class="mb-3">
                        <label for="release_date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="release_date" name="release_date" required>
                    </div>

                    <!-- Approved By Field -->
                    <div class="mb-3">
                        <label for="approved_by" class="form-label">Approved By</label>
                        <input type="text" class="form-control" id="approved_by" name="approved_by"
                            placeholder="Enter approver's name" required>
                    </div>

                    <!-- Document Upload Field -->
                    <div class="mb-3">
                        <label for="document" class="form-label">Upload Document</label>
                        <input type="file" class="form-control" id="document" name="document" required>
                    </div>

                    <!-- Validity Field -->
                    <div class="mb-3">
                        <label for="validity" class="form-label">Validity (Years)</label>
                        <input type="number" class="form-control" id="validity" name="validity"
                            placeholder="Enter validity in years" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save Document</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Pre-Certification Modal -->
<div class="modal fade" id="preCertificationModal" tabindex="-1" aria-labelledby="preCertLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="preCertForm" enctype="multipart/form-data">
                   {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="preCertLabel">Pre-Certification Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="consumableField" name="consumable">
                    <div class="mb-3">
                        <label for="certified_by" class="form-label">Certified By</label>
                        <select class="form-select" id="certified_by" name="certified_by" required>
                            {% for own in owner %}
                            <option value="{{ own.id }}">{{ own.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_ref" class="form-label">Certificate Reference No.</label>
                        <input type="text" class="form-control" id="certificate_ref" name="certificate_ref" required>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_issue_date" class="form-label">Issue Date</label>
                        <input type="date" class="form-control" id="certificate_issue_date" name="certificate_issue_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_valid_till" class="form-label">Valid Till</label>
                        <input type="date" class="form-control" id="certificate_valid_till" name="certificate_valid_till" required>
                    </div>
                    <div class="mb-3" id="Certificate_disposition">
                        <label class="form-label">Certificate disposition:</label>
                        
                        <div class="form-check">
                            <input class="form-check-input disposition-radio" type="radio" name="disposition" id="cleared" value="CLEARED" required>
                            <label class="form-check-label" for="cleared">
                                Cleared for use
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input disposition-radio" type="radio" name="disposition" id="pending" value="PENDING">
                            <label class="form-check-label" for="pending">
                                Cleared for use subject to completion of pending action
                            </label>
                            
                            <div id="pendingActionsContainer" style="display: none; margin-top: 10px; margin-left: 20px;">
                                <div id="pendingActionsList"></div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addPendingAction">
                                    <i class="bi bi-plus"></i> Add Pending Action
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input disposition-radio" type="radio" name="disposition" id="not_cleared" value="NOT_CLEARED">
                            <label class="form-check-label" for="not_cleared">
                                Not cleared
                            </label>
                        </div>
                    </div>

                    <!-- Template for pending action item (hidden) -->
                    <div id="pendingActionTemplate" style="display: none;">
                        <div class="pending-action-item mb-2">
                            <div class="input-group">
                                <input type="text" class="form-control" name="pending_actions[]" placeholder="Enter pending action details">
                                <button type="button" class="btn btn-outline-danger remove-action">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                     <div class="mb-3">
                    <label for="certificate_file" class="form-label">Upload Certificate</label>
                    <input type="file" class="form-control" id="certificate_file" name="certificate_file" accept=".pdf,.jpg,.png" required>

                </div>



                </div>
    
                <div class="modal-footer">
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>



document.addEventListener('DOMContentLoaded', function() {
    const pendingRadio = document.getElementById('pending');
    const pendingContainer = document.getElementById('pendingActionsContainer');
    const pendingList = document.getElementById('pendingActionsList');
    const addButton = document.getElementById('addPendingAction');
    const template = document.getElementById('pendingActionTemplate');
    
    // Show/hide pending actions container based on radio selection
    document.querySelectorAll('.disposition-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            pendingContainer.style.display = this.id === 'pending' ? 'block' : 'none';
        });
    });
    
    // Add new pending action
    addButton.addEventListener('click', function() {
        const newAction = template.cloneNode(true);
        newAction.style.display = 'block';
        newAction.removeAttribute('id');
        pendingList.appendChild(newAction);
        
        // Add event listener to remove button
        newAction.querySelector('.remove-action').addEventListener('click', function() {
            newAction.remove();
        });
    });
});













const gradeAcceptanceTests = {};
function clearMultiselectDropdown(dropdown) {
            for (let option of dropdown.options) {
                option.selected = false;
            }
        }

        
            function handleSelection() {
    console.log("handleSelection called");
    
            const gradeDropdown = document.getElementById("grade");
            const acceptanceDropdown = document.getElementById("acceptance_test");
            const selectedGrades = Array.from(gradeDropdown.selectedOptions).map(option => option.value);
            const selectedAcceptanceTests = Array.from(acceptanceDropdown.selectedOptions).map(option => option.value);
            const tableContainer = document.getElementById("acceptance_test_table");

            // Hide container if no grades selected
            if (selectedGrades.length === 0) {
                tableContainer.innerHTML = "";
                tableContainer.style.display = "none";
                return;
            }

            // Show container
            tableContainer.style.display = "block";

            // Step 1: Remove tables for grades that were removed
            const existingTables = Array.from(tableContainer.querySelectorAll("table"));
            existingTables.forEach(table => {
                const gradeIdMatch = table.id.match(/^grade_(.+)_acceptanceTestTable$/);
                if (gradeIdMatch) {
                    const gradeId = gradeIdMatch[1];
                    if (!selectedGrades.includes(gradeId)) {
                        table.remove();
                        delete gradeAcceptanceTests[gradeId];
                    }
                }
            });

            // Step 2: Loop through all selected grades
            selectedGrades.forEach(gradeId => {
                const gradeName = gradeDropdown.querySelector(`option[value="${gradeId}"]`).textContent;

                // Create or reuse table for this grade
                let gradeTable = document.getElementById(`grade_${gradeId}_acceptanceTestTable`);
                if (!gradeTable) {
                    gradeTable = document.createElement("table");
                    gradeTable.id = `grade_${gradeId}_acceptanceTestTable`;
                    gradeTable.className = "table table-striped";
                    gradeTable.innerHTML = `
                    <thead>
                        <tr><th colspan="2">Grade: ${gradeName}</th></tr>
                        <tr><th>Specification</th><th>Reevaluation Frequency</th></tr>
                    </thead>
                    <tbody id="grade_${gradeId}_acceptanceTestTableBody"></tbody>
                `;
                    tableContainer.appendChild(gradeTable);
                }

                const tableBody = document.getElementById(`grade_${gradeId}_acceptanceTestTableBody`);
                tableBody.innerHTML = ""; // clear before repopulating

                // Store selected acceptance tests
                gradeAcceptanceTests[gradeId] = selectedAcceptanceTests;

                selectedAcceptanceTests.forEach(testId => {
                    const testName = acceptanceDropdown.querySelector(`option[value="${testId}"]`).textContent;

                    // AJAX fetch
                    $.ajax({
                        url: `{% url "acceptance-list" %}?id=${testId}`,
                        type: 'GET',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                        success: function (response) {
                            if (response && response.acceptance_tests) {
                                response.acceptance_tests.forEach(test => {
                                    const reevaluationFrequency = `${test.reevaluation_frequency_value} ${test.reevaluation_frequency_unit}`;
                                    const testRow = `
                                    <tr id="grade_${gradeId}_test_${test.id}">
                                        <td>
                                            <strong>${test.name}</strong><br>
                                            Min: <input type="number" value="${test.min_value}" class="form-control min-value">
                                            Max: <input type="number" value="${test.max_value}" class="form-control max-value">
                                            Unit: <input type="text" value="${test.unit_name}" class="form-control unit-name">
                                        </td>
                                        <td>
                                            <input type="text" value="${reevaluationFrequency}" class="form-control reevaluation-frequency">
                                        </td>
                                    </tr>
                                `;
                                    tableBody.insertAdjacentHTML('beforeend', testRow);
                                });
                            } else {
                                alert('No acceptance tests found.');
                            }
                        },
                        error: function () {
                            alert('Failed to fetch acceptance tests. Please try again.');
                        }
                    });
                });
            });
        }

        // Function to clear a multiselect dropdown
        function clearMultiselectDropdown(dropdown) {
            Array.from(dropdown.options).forEach(option => {
                option.selected = false; // Deselect all options
            });
        }

        // Add event listener to the grade dropdown
        document.getElementById("grade").addEventListener("change", handleSelection);





        // Function to clear a multiselect dropdown
        function clearMultiselectDropdown(dropdown) {
            alert("entred dropdewon")
            dropdown = document.getElementById("acceptance_test");
            Array.from(dropdown.options).forEach(option => {
                option.selected = false; // Deselect all options
            });
        } 

    $(document).ready(function () {
        $('#shelf_life_duration_group').hide();
        $('#shelf_life_period_group').hide();

        $('#shelf_life_type').change(function () {
            const selectedOption = $(this).val();

            if (selectedOption === 'add_duration') {
                // Show duration and period inputs
                $('#shelf_life_duration_group').show();
                $('#shelf_life_period_group').show();
            } else {
                // Hide duration and period inputs
                $('#shelf_life_duration_group').hide();
                $('#shelf_life_period_group').hide();
            }
        });

        // Show Add Document Modal only if document_upload is checked
        $('#document_upload').change(function () {
            const consumable = $('#consumable').val().trim(); // Get consumable value
            const consumableInput = $('#consumable'); // consumable input field

            if (!consumable) {
                consumableInput.addClass('is-invalid'); // Add invalid styling
                if (!consumableInput.siblings('.text-danger').length) {
                    consumableInput.after('<span class="text-danger">Please enter the consumable name</span>');
                }
                $(this).prop('checked', false); // Uncheck document_upload
            } else {
                consumableInput.removeClass('is-invalid');
                consumableInput.siblings('.text-danger').remove();

                // Set the consumable name in the modal's hidden input field
                $('#consumableField').val(consumable);

                // Show the modal
                $('#addConsumableDocumentModal').modal('show');
            }
        });

   
        
        // Show Add Document Modal only if document_upload is checked
        $('#precertified').change(function () {
            const consumable = $('#consumable').val().trim(); // Get consumable value
            const consumableInput = $('#consumable'); // consumable input field
            const acceptanceInput = $('#acceptance_test'); // Acceptance input field

            if (!consumable) {
                consumableInput.addClass('is-invalid'); // Add invalid styling
                if (!consumableInput.siblings('.text-danger').length) {
                    consumableInput.after('<span class="text-danger">Please enter the consumable name</span>');
                }
                $(this).prop('checked', false); // Uncheck Precertified
            } else {
                consumableInput.removeClass('is-invalid');
                consumableInput.siblings('.text-danger').remove();

                // Set the consumable name in the modal's hidden input field
                $('#consumableField').val(consumable);

                // Show the modal
                $('#preCertificationModal').modal('show');
                // Disable the acceptance input field if precertified is checked
                if ($(this).is(':checked')) {
                    acceptanceInput.prop('disabled', true);
                } else {
                    acceptanceInput.prop('disabled', false);
                }
            }
        });
        
$('#submitButton').click(function (event) {
    event.preventDefault();

    // Clear previous error messages
    $('.error-message').remove();
    $('.form-control').removeClass('is-invalid');

    // Validate required fields
    var isValid = true;
    var requiredFields = ['consumable', 'shelf_life_type'];
    
    requiredFields.forEach(function(fieldId) {
        var field = $('#' + fieldId);
        if (!field.val().trim()) {
            field.addClass('is-invalid');
            var fieldName = fieldId === 'consumable' ? 'Consumable name' : 'Shelf life type';
            field.after('<div class="error-message text-danger">‚ö†Ô∏è ' + fieldName + ' is required.</div>');
            isValid = false;
        }
    });

    // Validate shelf life fields if type is 'add_duration'
    if ($('#shelf_life_type').val() === 'add_duration') {
        if (!$('#shelf_life_value').val()) {
            $('#shelf_life_value').addClass('is-invalid');
            $('#shelf_life_value').after('<div class="error-message text-danger">‚ö†Ô∏è Shelf life duration value is required when "Add Duration" is selected.</div>');
            isValid = false;
        }
        if (!$('#unit').val()) {
            $('#unit').addClass('is-invalid');
            $('#unit').after('<div class="error-message text-danger">‚ö†Ô∏è Shelf life period unit is required when "Add Duration" is selected.</div>');
            isValid = false;
        }
    }

    if (!isValid) {
        showAlert('‚ö†Ô∏è Please fill in all required fields correctly before submitting.', 'error');
        return;
    }

    // Show loading state directly without confirmation
    $('#submitButton').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...');

    const formData = new FormData();

    // Add basic fields
    formData.append('name', $('#consumable').val());
    formData.append('shelf_life_type', $('#shelf_life_type').val());
    
    // Only add shelf life values if type is 'add_duration'
    if ($('#shelf_life_type').val() === 'add_duration') {
        formData.append('shelf_life_value', $('#shelf_life_value').val());
        formData.append('shelf_life_unit', $('#unit').val());
    }
    
    formData.append('precertified', $('#precertified').is(':checked'));
    formData.append('document_upload', $('#document_upload').is(':checked'));

    // Add pre-certification data if applicable
    if ($('#precertified').is(':checked')) {
        formData.append('certified_by', $('#certified_by').val());
        formData.append('certificate_ref', $('#certificate_ref').val());
        formData.append('certificate_disposition', $('input[name="disposition"]:checked').val());
        formData.append('issue_date', $('#certificate_issue_date').val());
        formData.append('valid_till', $('#certificate_valid_till').val());

        const certificateFile = $('#certificate_file')[0].files[0];
        if (certificateFile) {
            formData.append('certificate_file', certificateFile);
        }
    }

    // Append multi-value fields
    const grade = $('#grade').val();
    if (grade) {
        grade.forEach((val) => formData.append('grade', val));
    }

    const sources = $('#sources').val();
    if (sources) {
        sources.forEach((val) => formData.append('sources', val));
    }

    const suppliers = $('#supplier').val();
    if (suppliers) {
        suppliers.forEach((val) => formData.append('suppliers', val));
    }

    // Collect acceptance test data
    const test_data = [];
    $('[id^="grade_"][id$="_acceptanceTestTableBody"], #mainAcceptanceTestTableBody').find('tr').each(function () {
        const rowId = $(this).attr('id');
        if (!rowId || !rowId.startsWith('grade_')) return;

        const gradeId = rowId.replace('_acceptanceTestTableBody', '');
        const acceptanceTestId = $(this).find('input[name="acceptance_test_id"]').val();
        const minValue = $(this).find('input[name="min_value"]').val();
        const maxValue = $(this).find('input[name="max_value"]').val();
        const unit = $(this).find('input[name="unit"]').val();

        if (acceptanceTestId && minValue && maxValue && unit) {
            test_data.push({
                grade_id: gradeId,
                acceptance_test_id: acceptanceTestId,
                min_value: minValue,
                max_value: maxValue,
                unit: unit
            });
        }
    });

    // Add test data to form
    if (test_data.length > 0) {
        formData.append('test_data', JSON.stringify(test_data));
    }

    // Add acceptance tests
    const acceptanceTests = $('#acceptance_test').val();
    if (acceptanceTests) {
        acceptanceTests.forEach((val) => formData.append('acceptance_test', val));
    }

    console.log('Submitting consumable data:', {
        name: $('#consumable').val(),
        shelf_life_type: $('#shelf_life_type').val(),
        test_data: test_data
    });

    $.ajax({
        type: 'POST',
        url: '{% url "consumable-add" %}',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function (response) {
            if (response.success) {
                var consumableName = $('#consumable').val();
                showAlert(`üéâ Consumable "${consumableName}" created successfully! The consumable has been added to your inventory and will redirect you to the list page.`, 'success');
                setTimeout(function() {
                    window.location.href = "{% url 'consumable-list' %}";
                }, 3000);
            } else {
                showAlert(response.message || '‚ùå Failed to create consumable. Please check your input and try again.', 'error');
            }
        },
        error: function (xhr, status, error) {
            var errorMessage = '‚ùå An error occurred while creating the consumable. Please try again.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = '‚ùå ' + xhr.responseJSON.message;
            }
            showAlert(errorMessage, 'error');
        },
        complete: function() {
            // Reset button state
            $('#submitButton').prop('disabled', false).html('Submit');
        }
    });
});

function showAlert(message, type) {
     if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: type === 'success' ? 'Success!' : 'Error!',
            text: message,
            icon: type,
            confirmButtonText: 'OK',
            confirmButtonColor: type === 'success' ? '#28a745' : '#dc3545',
            timer: type === 'success' ? 3000 : undefined,
            timerProgressBar: type === 'success' ? true : false
        });
    } else {
        // Fallback to regular alert if SweetAlert is not loaded
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('.page-header').after(alertHtml);
    }
}

    // Populate Category Dropdown Dynamically (Optional if already done in the template)
        //const categoryChoices = [
        //{ value: "", label: "Select a Value" },
        //{ value: "DOC/DOCX", label: ".doc/.docx" },
        // { value: "PDF", label: ".pdf" },
        // { value: "TXT", label: ".txt" },
        // { value: "XLS/XLSX", label: ".xls/.xlsx" },
        // { value: "CSV", label: ".csv" },
        // { value: "PPT/PPTX", label: ".ppt/.pptx" },
        // { value: "ODP", label: ".odp" },
        //  { value: "JPG/JPEG", label: ".jpg/.jpeg" },
        // { value: "PNG", label: ".png" },
        // { value: "ZIP", label: ".zip" },
        // { value: "RAR", label: ".rar" }
        //];

        //const categoryDropdown = $('#category');
        // categoryChoices.forEach(choice => {
        //     categoryDropdown.append(new Option(choice.label, choice.value));
        // });


        // Submit Document Form
        $('#addDocumentForm').submit(function (e) {
            e.preventDefault();
            var formData = new FormData(this);
            var consumable = $('#consumable').val();

            formData.append('consumable', consumable);

            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);

            }

            $.ajax({
                url: '{% url "add-consumable-document" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        showAlert('üìÑ Document added successfully!', 'success');
                        $('#addConsumableDocumentModal').modal('hide');
                    } else {
                        showAlert(response.message || '‚ùå Failed to add document. Please try again.', 'error');
                    }
                },
                error: function () {
                    showAlert('‚ùå Error adding document. Please try again.', 'error');
                }
            });
        });
        // Pre-certification Form submission code commented out for now
        // $('#preCertForm').submit(function (e) {
        //     e.preventDefault();
        //     var formData = new FormData(this);
        //     var consumable = $('#consumable').val();
        //     formData.append('consumable', consumable);
        //     // ... rest of the code
        // });


    });
</script>
{% endblock %}