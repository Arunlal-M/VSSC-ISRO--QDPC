{% extends 'index.html' %}
{% block content %}
   {% load static %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Add Raw Material</h4>
            </div>
            <a href="{% url 'raw-material' %}" class="btn btn-added">Back to List</a>
        </div>
        <!-- /add -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label>Raw Material Name <span class="text-danger">*</span></label>
                            <input type="text" name="raw-material" id="raw-material" class="form-control" required>
                            <div class="invalid-feedback">Raw material name is required</div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="supplier" class="form-label">Suppliers <span class="text-danger">*</span></label>
                        <select class="select" id="supplier" name="supplier[]" multiple required>
                            <option value="">Select Suppliers</option>
                            {% for sup in suppliers %}
                            <option value="{{ sup.id }}">{{ sup.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">At least one supplier is required</div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="sources" class="form-label">Sources <span class="text-danger">*</span></label>
                        <select class="select" id="sources" name="sources[]" multiple required>
                            <option value="">Select Sources</option>
                            {% for sour in sources %}
                            <option value="{{ sour.id }}">{{ sour.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">At least one source is required</div>
                    </div>

                     <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="precertified" class="form-label">Pre-Certified</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="precertified" name="precertified">
                                <label class="form-check-label" for="precertified">Check if Pre-Certified</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="grade">Grade <span class="text-danger">*</span></label>
                            <select class="select" id="grade" name="grade" multiple onchange="handleSelection()" required>
                                <option value="">Select Grades</option>
                                {% for grade in grades %}
                                <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">At least one grade is required</div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="acceptance_test" class="form-label">Acceptance Test</label>
                        <select class="select" id="acceptance_test" name="acceptance_test" multiple
                            onchange="handleSelection()">
                            <option value="">Select Acceptance Tests</option>
                            {% for acc in acceptence_test %}
                            <option value="{{ acc.id }}">{{ acc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="shelf_life_type">Shelf Life</label>
                            <select id="shelf_life_type" name="shelf_life_type" class="form-control">
                                <option value="">Choose Type</option>
                                <option value="tbd">TBD (To Be Decided)</option>
                                <option value="not_applicable">Not Applicable</option>
                                <option value="add_duration">Add Duration</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4" id="shelf_life_duration_group" style="display: none;">
                        <div class="form-group">
                            <label for="shelf_life_value">Shelf Life Duration <span class="text-danger">*</span></label>
                            <input type="number" id="shelf_life_value" name="shelf_life_value" class="form-control"
                                placeholder="Enter duration" min="1" step="0.01">
                            <div class="invalid-feedback">Shelf life duration is required and must be greater than 0</div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4" id="shelf_life_period_group" style="display: none;">
                        <div class="form-group">
                            <label for="shelf_life_unit">Shelf Life Period <span class="text-danger">*</span></label>
                            <select id="shelf_life_unit" name="shelf_life_unit" class="form-control">
                                <option value="">Select Period</option>
                                <option value="days">Days</option>
                                <option value="months">Months</option>
                                <option value="years">Years</option>
                            </select>
                            <div class="invalid-feedback">Shelf life period is required</div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="form-group">
                            <label for="document_upload" class="form-label">Document Upload</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="document_upload" name="document_upload">
                                <label class="form-check-label" for="document_upload">Check to upload Document</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <button type="button" id="submitButton" class="btn btn-submit me-2">
                            <span class="btn-text">Submit</span>
                            <span class="btn-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Submitting...
                            </span>
                        </button>
                        <a href="{% url 'raw-material-add' %}" class="btn btn-cancel">Clear</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- /add -->
    </div>

    <div class="container mt-5">
        <h1>Acceptance Test Specifications</h1>
        <!-- Div where the table will be created dynamically -->
        <div class="content" id="acceptance_test_table" style="display: none;">
            <!-- Table will be appended here via JavaScript -->
        </div>
    </div>
    <!-- /Main Wrapper -->

    <!-- Add Document Modal -->
    <div class="modal fade" id="addRawMaterialDocumentModal" tabindex="-1" aria-labelledby="addDocumentLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="addDocumentForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDocumentLabel">Add Raw Material Document</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                    </div>
                    <div class="modal-body">
                        <!-- Hidden field for Raw Material -->
                        <input type="hidden" id="rawMaterialField" name="raw_material">

                        <!-- Title Field -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title"
                                placeholder="Enter document title" required>
                        </div>

                        <!-- Category Dropdown -->
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category" required>
                                <option>Choose Document Type</option>
                                {% for doc_type in document_types %}
                                <option value="{{ doc_type.id }}">{{ doc_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                         <!-- Issue Number Field -->
                        <div class="mb-3">
                            <label for="issue_no" class="form-label">Issue Number</label>
                            <input type="text" class="form-control" id="issue_no" name="issue_no"
                                placeholder="Enter issue number" required>
                        </div>

                        <!-- Revision Number Field -->
                        <div class="mb-3">
                            <label for="revision_no" class="form-label">Revision Number</label>
                            <input type="text" class="form-control" id="revision_no" name="revision_no"
                                placeholder="Enter revision number" required>
                        </div>

                        <!-- Release Date Field -->
                        <div class="mb-3">
                            <label for="release_date" class="form-label">Release Date</label>
                            <input type="date" class="form-control" id="release_date" name="release_date" required>
                        </div>

                        <!-- Approved By Field -->
                        <div class="mb-3">
                            <label for="approved_by" class="form-label">Approved By</label>
                            <input type="text" class="form-control" id="approved_by" name="approved_by"
                                placeholder="Enter approver's name" required>
                        </div>

                        <!-- Document Upload Field -->
                        <div class="mb-3">
                            <label for="document" class="form-label">Upload Document</label>
                            <input type="file" class="form-control" id="document" name="document" required>
                        </div>

                        <!-- Validity Field -->
                        <div class="mb-3">
                            <label for="validity" class="form-label">Validity (Years)</label>
                            <input type="number" class="form-control" id="validity" name="validity"
                                placeholder="Enter validity in years" min="1" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Document</button>
                    </div>
                </form>
            </div>
        </div>
    </div> 

<!-- Pre-Certification Modal -->
<div class="modal fade" id="preCertificationModal" tabindex="-1" aria-labelledby="preCertLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="preCertForm" enctype="multipart/form-data">
                   {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="preCertLabel">Pre-Certification Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="consumableField" name="consumable">
                    <div class="mb-3">
                        <label for="certified_by" class="form-label">Certified By</label>
                        <select class="form-select" id="certified_by" name="certified_by" required>
                            {% for own in owner %}
                            <option value="{{ own.id }}">{{ own.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_ref" class="form-label">Certificate Reference No.</label>
                        <input type="text" class="form-control" id="certificate_ref" name="certificate_ref" required>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_issue_date" class="form-label">Issue Date</label>
                        <input type="date" class="form-control" id="certificate_issue_date" name="certificate_issue_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="certificate_valid_till" class="form-label">Valid Till</label>
                        <input type="date" class="form-control" id="certificate_valid_till" name="certificate_valid_till" required>
                    </div>
                    <div class="mb-3" id="Certificate_disposition">
                        <label class="form-label">Certificate disposition:</label>
                        
                        <div class="form-check">
                            <input class="form-check-input disposition-radio" type="radio" name="disposition" id="cleared" value="CLEARED" required>
                            <label class="form-check-label" for="cleared">
                                Cleared for use
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input disposition-radio" type="radio" name="disposition" id="pending" value="PENDING">
                            <label class="form-check-label" for="pending">
                                Cleared for use subject to completion of pending action
                            </label>
                            
                            <div id="pendingActionsContainer" style="display: none; margin-top: 10px; margin-left: 20px;">
                                <div id="pendingActionsList"></div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addPendingAction">
                                    <i class="bi bi-plus"></i> Add Pending Action
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input disposition-radio" type="radio" name="disposition" id="not_cleared" value="NOT_CLEARED">
                            <label class="form-check-label" for="not_cleared">
                                Not cleared
                            </label>
                        </div>
                    </div>

                    <!-- Template for pending action item (hidden) -->
                    <div id="pendingActionTemplate" style="display: none;">
                        <div class="pending-action-item mb-2">
                            <div class="input-group">
                                <input type="text" class="form-control" name="pending_actions[]" placeholder="Enter pending action details">
                                <button type="button" class="btn btn-outline-danger remove-action">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                     <div class="mb-3">
                    <label for="certificate_file" class="form-label">Upload Certificate</label>
                    <input type="file" class="form-control" id="certificate_file" name="certificate_file" accept=".pdf,.jpg,.png" required>

                </div>



                </div>
    
                <div class="modal-footer">
                    
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

    {% endblock %}

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% block scripts %}
<script>
    $(document).ready(function () {
        // Initialize shelf life fields
        $('#shelf_life_duration_group').hide();
        $('#shelf_life_period_group').hide();

        // Shelf life type change handler
        $('#shelf_life_type').change(function () {
            const selectedOption = $(this).val();
            clearValidation();

            if (selectedOption === 'add_duration') {
                $('#shelf_life_duration_group').show();
                $('#shelf_life_period_group').show();
                // Make fields required
                $('#shelf_life_value, #shelf_life_unit').prop('required', true);
            } else {
                $('#shelf_life_duration_group').hide();
                $('#shelf_life_period_group').hide();
                // Remove required
                $('#shelf_life_value, #shelf_life_unit').prop('required', false);
                // Clear values
                $('#shelf_life_value, #shelf_life_unit').val('');
            }
        });

        // Document upload checkbox handler
        $('#document_upload').change(function() {
            const rawMaterialName = $('#raw-material').val().trim();
            
            if ($(this).is(':checked')) {
                if (!rawMaterialName) {
                    $('#raw-material').addClass('is-invalid');
                    if (!$('#raw-material').siblings('.text-danger').length) {
                        $('#raw-material').after('<span class="text-danger">Please enter the raw material name first</span>');
                    }
                    $(this).prop('checked', false);
                    return;
                }
                
                $('#raw-material').removeClass('is-invalid');
                $('#raw-material').siblings('.text-danger').remove();
                
                $('#rawMaterialField').val(rawMaterialName);
                $('#addRawMaterialDocumentModal').modal('show');
            }
        });

        // Real-time validation
        $('#raw-material').on('input', function() {
            validateField($(this));
        });

        $('#grade, #sources, #supplier').on('change', function() {
            validateField($(this));
        });

        // Submit main form
        $('#submitButton').click(function (event) {
            event.preventDefault();
            
            if (validateForm()) {
                submitForm();
            }
        });

        // Document form submission
        $('#addDocumentForm').submit(function (e) {
            e.preventDefault();
            var formData = new FormData(this);
            var raw_material = $('#raw-material').val();

            formData.append('raw_material', raw_material);

            $.ajax({
                url: '{% url "add-raw-material-document" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        $('#addRawMaterialDocumentModal').modal('hide');
                        showSuccessAlert('Success!', 'Document added successfully');
                        // Reset form
                        $('#addDocumentForm')[0].reset();
                    } else {
                        showErrorAlert('Error!', response.message || 'Failed to add document');
                    }
                },
                error: function () {
                    showErrorAlert('Error!', 'Error adding document. Please try again.');
                }
            });
        });
    });

    function validateField(field) {
        const value = field.val();
        const isRequired = field.prop('required');
        
        if (isRequired && !value) {
            field.addClass('is-invalid').removeClass('is-valid');
            return false;
        } else if (value) {
            field.addClass('is-valid').removeClass('is-invalid');
            return true;
        } else {
            field.removeClass('is-invalid is-valid');
            return true;
        }
    }

    function validateForm() {
        let isValid = true;
        clearValidation();

        // Validate required fields
        const requiredFields = ['#raw-material', '#grade', '#sources', '#supplier'];
        requiredFields.forEach(field => {
            if (!validateField($(field))) {
                isValid = false;
            }
        });

        // Validate shelf life configuration
        const shelfLifeType = $('#shelf_life_type').val();
        if (shelfLifeType === 'add_duration') {
            if (!validateField($('#shelf_life_value'))) {
                isValid = false;
            }
            if (!validateField($('#shelf_life_unit'))) {
                isValid = false;
            }
        }

        return isValid;
    }

    function clearValidation() {
        $('.form-control, .select').removeClass('is-invalid is-valid');
        $('.text-danger').remove();
    }

    function submitForm() {
        // Show loading state
        $('.btn-text').hide();
        $('.btn-loading').show();
        $('#submitButton').prop('disabled', true);

        const formData = new FormData();

        // Add basic fields
        formData.append('name', $('#raw-material').val());
        formData.append('shelf_life_type', $('#shelf_life_type').val());
        formData.append('shelf_life_value', $('#shelf_life_value').val());
        formData.append('shelf_life_unit', $('#shelf_life_unit').val());
        formData.append('precertified', $('#precertified').is(':checked'));
        formData.append('document_upload', $('#document_upload').is(':checked'));

        // Add multi-value fields
        const grade = $('#grade').val();
        if (grade) {
            grade.forEach((val) => formData.append('grade', val));
        }

        const sources = $('#sources').val();
        if (sources) {
            sources.forEach((val) => formData.append('sources', val));
        }

        const suppliers = $('#supplier').val();
        if (suppliers) {
            suppliers.forEach((val) => formData.append('suppliers', val));
        }

        // Collect test data
        const test_data = [];
        $('[id^="grade_"][id$="_acceptanceTestTableBody"], #mainAcceptanceTestTableBody').find('tr').each(function () {
            const rowId = $(this).attr('id');
            if (!rowId || !rowId.startsWith('grade_')) return;

            const parts = rowId.split('_');
            const test_id = parts.length > 0 ? parts[parts.length - 1] : null;
            const grade_id = parts.length >= 3 ? parts[1] : null;

            const min_value = $(this).find('.min-value').val();
            const max_value = $(this).find('.max-value').val();
            const unit_name = $(this).find('.unit-name').val();
            const reevaluation_frequency = $(this).find('.reevaluation-frequency').val();

            test_data.push({
                name: $('#raw-material').val(),
                acceptance_test_id: test_id,
                grade_id: grade_id,
                min_value: min_value || null,
                max_value: max_value || null,
                unit_name: unit_name || null,
                reevaluation_frequency: reevaluation_frequency || null
            });
        });

        formData.append('test_data', JSON.stringify(test_data));
        
        $.ajax({
            type: 'POST',
            url: '{% url "raw-material-add" %}',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.success) {
                    showSuccessAlert('Success!', response.message);
                    setTimeout(function () {
                        window.location.href = "{% url 'raw-material' %}";
                    }, 2000);
                } else {
                    showErrorAlert('Error!', response.message || 'Data submission failed. Please try again.');
                }
            },
            error: function (xhr) {
                let errorMessage = 'An error occurred. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                showErrorAlert('Error!', errorMessage);
            },
            complete: function() {
                // Reset button state
                $('.btn-text').show();
                $('.btn-loading').hide();
                $('#submitButton').prop('disabled', false);
            }
        });
    }

    function showSuccessAlert(title, message) {
        Swal.fire({
            icon: 'success',
            title: title,
            text: message,
            timer: 3000,
            showConfirmButton: false
        });
    }

    function showErrorAlert(title, message) {
        Swal.fire({
            icon: 'error',
            title: title,
            text: message,
            confirmButtonText: 'OK'
        });
    }

    // Handle acceptance test selection
    function handleSelection() {
        const selectedGrades = $('#grade').val();
        const selectedTests = $('#acceptance_test').val();
        
        if (selectedGrades && selectedGrades.length > 0 && selectedTests && selectedTests.length > 0) {
            createAcceptanceTestTable(selectedGrades, selectedTests);
            $('#acceptance_test_table').show();
        } else {
            $('#acceptance_test_table').hide();
        }
    }

    function createAcceptanceTestTable(grades, tests) {
        const container = document.getElementById('acceptance_test_table');
        container.innerHTML = '';

        grades.forEach(gradeId => {
            const gradeName = $(`#grade option[value="${gradeId}"]`).text();
            
            const tableDiv = document.createElement('div');
            tableDiv.className = 'mb-4';
            tableDiv.innerHTML = `
                <h3>Grade: ${gradeName}</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Acceptance Test</th>
                            <th>Min Value</th>
                            <th>Max Value</th>
                            <th>Unit</th>
                            <th>Reevaluation Frequency</th>
                        </tr>
                    </thead>
                    <tbody id="grade_${gradeId}_acceptanceTestTableBody">
                    </tbody>
                </table>
            `;
            
            container.appendChild(tableDiv);
            
            const tbody = tableDiv.querySelector(`#grade_${gradeId}_acceptanceTestTableBody`);
            
            tests.forEach(testId => {
                const testName = $(`#acceptance_test option[value="${testId}"]`).text();
                
                const row = document.createElement('tr');
                row.id = `grade_${gradeId}_${testId}`;
                row.innerHTML = `
                    <td>${testName}</td>
                    <td><input type="number" class="form-control min-value" placeholder="Min"></td>
                    <td><input type="number" class="form-control max-value" placeholder="Max"></td>
                    <td><input type="text" class="form-control unit-name" placeholder="Unit"></td>
                    <td><input type="number" class="form-control reevaluation-frequency" placeholder="Frequency"></td>
                `;
                
                tbody.appendChild(row);
            });
        });
    }
</script>

<style>
    .is-invalid {
        border-color: #dc3545 !important;
    }
    .is-valid {
        border-color: #198754 !important;
    }
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
    .text-danger {
        color: #dc3545 !important;
    }
    .btn-loading {
        display: none;
    }
    .select.is-invalid {
        border-color: #dc3545 !important;
    }
    .select.is-valid {
        border-color: #198754 !important;
    }
</style>
{% endblock %}