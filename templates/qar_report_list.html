{% extends 'index.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="content container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">{{ page_title }}</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'user-dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item active">QAR Report - Approved Batches</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Approved Product Batches</h4>
                        <p class="card-text">View approved product batches and generate QAR reports</p>
                        
                        <!-- Summary Stats -->
                        <div class="row mt-3">
                            <div class="col-md-12 text-end">
                                <span class="badge bg-primary">Total Approved: {{ debug_info.approved_count }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">

                        
                        {% if all_batches %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Product Name</th>
                                            <th>Batch ID</th>
                                            <th>Manufacturing Start</th>
                                            <th>Manufacturing End</th>
                                            <th>QA Approval Date</th>
                                            <th>Approved By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for batch in all_batches %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <strong>{{ batch.product.name }}</strong>
                                                {% if batch.product.category %}
                                                    <br><small class="text-muted">{{ batch.product.category.name }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ batch.batch_id }}</span>
                                            </td>

                                            <td>{{ batch.manufacturing_start|date:"d/m/Y" }}</td>
                                            <td>{{ batch.manufacturing_end|date:"d/m/Y" }}</td>
                                            <td>
                                                {% if batch.qa_approval_date %}
                                                    {{ batch.qa_approval_date|date:"d/m/Y H:i" }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if batch.qa_approved_by %}
                                                    {{ batch.qa_approved_by.username }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'generate_qar' batch.id %}?editable=true" 
                                                       class="btn btn-sm btn-success" 
                                                       title="Edit QAR Report">
                                                        <i class="fas fa-edit"></i> Edit QAR
                                                    </a>
                                                    <a href="{% url 'generate_qar' batch.id %}" 
                                                       class="btn btn-sm btn-warning" 
                                                       title="Generate QAR Report">
                                                        <i class="fas fa-file-pdf"></i> Generate QAR
                                                    </a>
                                                    <a href="{% url 'generate_qar' batch.id %}?format=pdf" 
                                                       class="btn btn-sm btn-danger" 
                                                       title="Download PDF">
                                                        <i class="fas fa-download"></i> PDF
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Approved Product Batches Found</h5>
                                    <p class="text-muted">There are currently no approved product batches available for QAR report generation.</p>
                                    <a href="{% url 'product-batch-list' %}" class="btn btn-primary">
                                        <i class="fas fa-arrow-left"></i> Go to Product Batches
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.empty-state {
    padding: 2rem;
}

.empty-state i {
    color: #6c757d;
}

.btn-group .btn {
    margin-right: 0.25rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.btn-warning {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529 !important;
}

.btn-warning:hover {
    background-color: #e0a800 !important;
    border-color: #d39e00 !important;
    color: #212529 !important;
}

.btn-danger {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: #ffffff !important;
}

.btn-danger:hover {
    background-color: #c82333 !important;
    border-color: #bd2130 !important;
    color: #ffffff !important;
}

.table th {
    background-color: #f8f9fa;
    border-top: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
}

.badge {
    font-size: 0.875em;
    padding: 0.5em 0.75em;
    font-weight: 600;
}

.badge.bg-primary {
    background-color: #007bff !important;
    color: #ffffff !important;
}

.badge.bg-success {
    background-color: #28a745 !important;
}

.badge.bg-info {
    background-color: #17a2b8 !important;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: none;
}

.card-header h4 {
    color: white;
    margin-bottom: 0.5rem;
}

.card-header p {
    color: rgba(255,255,255,0.9);
    margin-bottom: 0;
}

.table-responsive {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    transition: all 0.2s ease;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

.status-filter {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}

.filter-badges {
    margin-top: 0.5rem;
}

.filter-badges .badge {
    margin-right: 0.5rem;
}
 
 .card-header {
     background-color: #f8f9fa;
     border-bottom: 1px solid #dee2e6;
 }
 
 .card-title {
     color: #495057;
     margin-bottom: 0.5rem;
 }
 
 .card-text {
     color: #6c757d;
     margin-bottom: 0;
 }
</style>

<!-- Error Handling Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="errorMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="successMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
// Error handling for QAR report generation
document.addEventListener('DOMContentLoaded', function() {
    // Check for error messages in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    const success = urlParams.get('success');
    
    if (error) {
        showError(decodeURIComponent(error));
    }
    
    if (success) {
        showSuccess(decodeURIComponent(success));
    }
    
    // Add error handling to Generate QAR buttons
    const generateButtons = document.querySelectorAll('a[href*="generate_qar"]');
    generateButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Add loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            this.disabled = true;
            
            // Check if this is a PDF download
            const isPDF = this.href.includes('format=pdf');
            
            // For PDF downloads, let the browser handle it
            if (isPDF) {
                return;
            }
            
            // For HTML view, handle with AJAX for better error handling
            e.preventDefault();
            
            fetch(this.href, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to generate QAR report');
                    });
                }
                // Success - redirect to the QAR report page
                window.location.href = this.href;
            })
            .catch(error => {
                showError(error.message);
                // Reset button state
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });
    });
});

function showError(message) {
    document.getElementById('errorMessage').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Error:</strong> ${message}
        </div>
    `;
    new bootstrap.Modal(document.getElementById('errorModal')).show();
}

function showSuccess(message) {
    document.getElementById('successMessage').innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <strong>Success:</strong> ${message}
        </div>
    `;
    new bootstrap.Modal(document.getElementById('successModal')).show();
}

// Global error handler for unhandled errors
window.addEventListener('error', function(e) {
    console.error('Unhandled error:', e.error);
    showError('An unexpected error occurred. Please try again.');
});

// Handle AJAX errors globally
$(document).ajaxError(function(event, xhr, settings, error) {
    let errorMessage = 'An error occurred while processing your request.';
    
    if (xhr.responseJSON && xhr.responseJSON.message) {
        errorMessage = xhr.responseJSON.message;
    } else if (xhr.status === 404) {
        errorMessage = 'The requested resource was not found.';
    } else if (xhr.status === 500) {
        errorMessage = 'Internal server error. Please try again later.';
    } else if (xhr.status === 401) {
        errorMessage = 'Authentication required. Please log in again.';
    } else if (xhr.status === 403) {
        errorMessage = 'Access denied. You do not have permission to perform this action.';
    }
    
    showError(errorMessage);
});
</script>

{% endblock %}
