{% extends 'index.html' %}
{% load static %}
{% csrf_token %}

{% block content %}
<style>
    .status-badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-weight: 500;
    }
    
    .qa-comments {
        max-width: 200px;
        word-wrap: break-word;
    }
    
    .qa-comments small {
        line-height: 1.3;
    }
    
    .qa-comments .text-success {
        color: #198754 !important;
    }
    
    .qa-comments .text-danger {
        color: #dc3545 !important;
    }
    
    .qa-comments .text-muted {
        color: #6c757d !important;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .actions {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }
    
    .actions .btn {
        margin: 0;
    }
    
    .pending-approval {
        color: #6c757d;
        font-style: italic;
        font-size: 0.875rem;
    }
    
    .generate-report-btn {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
    
    .generate-report-btn:hover {
        background-color: #138496;
        border-color: #117a8b;
    }
    
    .btn.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn.disabled:hover {
        opacity: 0.6;
    }
    

</style>

<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Product Batch List</h4>
                <p class="text-muted">Manage and review product batches</p>
            </div>
            <div class="page-btn">
                <!-- Add New Batch button - dynamically check add permission -->
                {% if user.is_superuser or can_add_product_batch %}
                    <a href="{% url 'product-batch-add' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Batch
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Product Batch List -->
        <div class="card">
            <div class="card-body">
                
                <!-- Status Info -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Successfully loaded {{ total_count }} product batches
                        </div>
                    </div>
                </div>

                <!-- Permission Status Info -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Your Permissions for Product Batch</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>User:</strong> {{ user.username }}<br>
                                    <strong>Role:</strong> 
                                    {% for group in user.groups.all %}
                                        {{ group.name }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        None
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <strong>Dashboard Permissions:</strong><br>
                                    • Add: {{ can_add_product_batch|yesno:"Yes,No" }}<br>
                                    • Edit: {{ can_edit_product_batch|yesno:"Yes,No" }}<br>
                                    • Delete: {{ can_delete_product_batch|yesno:"Yes,No" }}<br>
                                    • Approve: {{ can_approve_product_batch|yesno:"Yes,No" }}<br>
                                    • View: {{ can_access_product_batch|yesno:"Yes,No" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    {% if batches %}
                        <table class="table table-striped table-hover" id="productBatchTable">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Product</th>
                                    <th>Batch Id</th>
                                    <th>Manufacturing Start</th>
                                    <th>Manufacturing End</th>
                                    <th>Status</th>
                                    <th>QA Comments</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for batch in batches %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ batch.product.name|default:"N/A" }}</td>
                                    <td>{{ batch.batch_id|default:"N/A" }}</td>
                                    <td>{{ batch.manufacturing_start|default:"N/A" }}</td>
                                    <td>{{ batch.manufacturing_end|default:"N/A" }}</td>
                                    <td>
                                        {% if batch.status == 'approved' %}
                                            <span class="badge bg-success">Approved</span>
                                        {% elif batch.status == 'rejected' %}
                                            <span class="badge bg-danger">Rejected</span>
                                        {% elif batch.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ batch.status|default:"Unknown" }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if batch.status == 'approved' %}
                                            {% if batch.qa_approved_by %}
                                                <small class="text-success">
                                                    <strong>Approved by:</strong> {{ batch.qa_approved_by.username|default:"Unknown" }}<br>
                                                    <strong>Date:</strong> {{ batch.qa_approval_date|date:'Y-m-d H:i'|default:'N/A' }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">Approved</span>
                                            {% endif %}
                                        {% elif batch.status == 'rejected' %}
                                            {% if batch.rejection_reason %}
                                                <small class="text-danger">
                                                    <strong>Rejected:</strong> {{ batch.rejection_reason|truncatechars:50 }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">Rejected</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Pending QA Review</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <!-- View button for all users -->
                                            <a href="{% url 'product-batch-single-view' batch.id %}" class="btn btn-sm btn-light" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            <!-- Show Edit button only if user has edit permission -->
                                            {% if user.is_superuser or can_edit_product_batch %}
                                                <a href="{% url 'product-batch-edit' batch.id %}" class="btn btn-sm btn-warning" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            {% endif %}
                                            
                                            <!-- Approve button - only show for pending batches and users with approve permission -->
                                            {% if batch.status == 'pending' and user.is_superuser or batch.status == 'pending' and can_approve_product_batch %}
                                                <button class="btn btn-sm btn-success approve-batch-btn" data-batch-id="{{ batch.id }}" data-batch-name="{{ batch.batch_id }}" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            {% elif batch.status == 'approved' %}
                                                <span class="btn btn-sm btn-success disabled" title="Already Approved">
                                                    <i class="fas fa-check-circle"></i>
                                                </span>
                                            {% endif %}
                                            
                                            <!-- Reject button - only show for pending batches and users with approve permission -->
                                            {% if batch.status == 'pending' and user.is_superuser or batch.status == 'pending' and can_approve_product_batch %}
                                                <button class="btn btn-sm btn-danger reject-batch-btn" data-batch-id="{{ batch.id }}" title="Reject">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            {% elif batch.status == 'rejected' %}
                                                <span class="btn btn-sm btn-danger disabled" title="Already Rejected">
                                                    <i class="fas fa-times-circle"></i>
                                                </span>
                                            {% endif %}
                                            
                                            <!-- Delete button - dynamically check delete permission -->
                                            {% if user.is_superuser or can_delete_product_batch %}
                                                <button class="delete-batch-btn btn btn-sm btn-danger" data-batch-id="{{ batch.id }}" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                            
                                            <!-- QAR Report Download button - only visible for approved batches -->
                                            {% if batch.status == 'approved' %}
                                                <button class="btn btn-sm btn-info qar-download-btn" data-batch-id="{{ batch.id }}" title="Download QAR Report" onclick="downloadQARReport({{ batch.id }})">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No product batches found.
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Pagination Controls -->
                {% if is_paginated %}
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div class="text-muted">
                        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} results
                    </div>
                    <nav aria-label="Product batch pagination">
                        <ul class="pagination pagination-sm mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% endif %}

                            {% for page_num in page_range %}
                                {% if page_num == page_obj.number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% elif page_num == '...' %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>         
        <!-- /product list -->
    </div>
</div>


<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvalModalLabel">Approve Product Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="approvalForm">
                    <input type="hidden" id="batchIdToApprove" name="batch_id">
                    <div class="mb-3">
                        <label for="approvalRemarks" class="form-label">Approval Remarks</label>
                        <textarea class="form-control" id="approvalRemarks" name="approval_remarks" rows="4" placeholder="Enter your approval remarks, comments, or notes..."></textarea>
                        <div class="form-text">Please provide any remarks, comments, or notes regarding this approval.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitApproval()">
                    <i class="fas fa-check"></i> Approve Batch
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>


$(document).ready(function() {
    
    // Initialize page
    console.log('Product batch list page loaded successfully');

    // Delete Batch Button Handler
   $('.delete-batch-btn').click(function () {
    const batchId = $(this).data('batch-id');

    Swal.fire({
      title: 'Are you sure?',
      text: "This will delete the batch and all related data!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        // Proceed with deletion
        deleteBatch(batchId);
      }
    });
  });

  // Show approval modal
  window.showApprovalModal = function(batchId) {
    document.getElementById('batchIdToApprove').value = batchId;
    document.getElementById('approvalRemarks').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
  };

  // Submit approval
  window.submitApproval = function() {
    const batchId = document.getElementById('batchIdToApprove').value;
    const remarks = document.getElementById('approvalRemarks').value;
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('approvalModal'));
    modal.hide();
    
    // Proceed with approval
    approveBatch(batchId, remarks);
  };

  // Reject Batch Button Handler
  $('.reject-batch-btn').click(function () {
    const batchId = $(this).data('batch-id');

    Swal.fire({
      title: 'Reject Batch?',
      text: "This will reject the product batch and change its status to rejected.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, reject it!',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        // Proceed with rejection
        rejectBatch(batchId);
      }
    });
  });

  function deleteBatch(batchId) {
    $.ajax({
      url: `/product/product-batch/${batchId}/delete/`, 
      type: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function (response) {
        if (response.success) {
          Swal.fire('Deleted!', 'Batch was deleted successfully.', 'success');
          $(`[data-batch-id="${batchId}"]`).closest('tr').remove(); 
        } else {
          Swal.fire('Error', response.message || 'Failed to delete batch.', 'error');
        }
      },
      error: function (xhr) {
        Swal.fire('Server Error', xhr.responseJSON?.detail || 'An error occurred.', 'error');
      }
    });
  }

  function approveBatch(batchId, remarks = '') {
    // Show loading state
    Swal.fire({
      title: 'Approving Batch...',
      text: 'Please wait while we process your approval.',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    $.ajax({
      url: `/product/product-batches/${batchId}/approve/`, 
      type: 'POST',
      data: {
        approval_remarks: remarks
      },
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function (response) {
        if (response.success) {
          Swal.fire({
            title: 'Approved!',
            text: `Batch was approved successfully.${remarks ? ' Remarks: ' + remarks : ''}`,
            icon: 'success',
            confirmButtonText: 'OK'
          }).then(() => {
            // Reload the page to show updated status
            location.reload();
          });
        } else {
          Swal.fire('Error', response.message || 'Failed to approve batch.', 'error');
        }
      },
      error: function (xhr) {
        Swal.fire('Server Error', xhr.responseJSON?.detail || 'An error occurred.', 'error');
      }
    });
  }

  function rejectBatch(batchId, rejectionReason) {
    $.ajax({
      url: `/product/product-batches/${batchId}/reject/`, 
      type: 'POST',
      data: {
        rejection_reason: rejectionReason
      },
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function (response) {
        if (response.success) {
          Swal.fire('Rejected!', `Batch was rejected successfully.${rejectionReason ? ' Reason: ' + rejectionReason : ''}`, 'success');
          // Reload the page to show updated status
          location.reload();
        } else {
          Swal.fire('Error', response.message || 'Failed to reject batch.', 'error');
        }
      },
      error: function (xhr) {
        Swal.fire('Server Error', xhr.responseJSON?.detail || 'An error occurred.', 'error');
      }
    });
  }



  // Submit to Division Head QA
  function submitToDivision(batchId) {
    $.ajax({
      url: `/product/product-batch/${batchId}/submit-to-division/`,
      type: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function (response) {
        if (response.success) {
          Swal.fire('Success!', response.message, 'success').then(() => {
            location.reload(); // Refresh the page to show updated status
          });
        } else {
          Swal.fire('Error', response.message || 'Failed to submit batch.', 'error');
        }
      },
      error: function (xhr) {
        let errorMessage = 'An error occurred while submitting the batch.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMessage = xhr.responseJSON.message;
        }
        Swal.fire('Error', errorMessage, 'error');
      }
    });
  }



  // Approve Batch Button Handler - Direct approval with remarks
  $('.approve-batch-btn').click(function () {
    const batchId = $(this).data('batch-id');
    const batchName = $(this).data('batch-name');

    Swal.fire({
      title: 'Approve Product Batch?',
      text: `Do you want to approve batch "${batchName}"?`,
      icon: 'question',
      input: 'textarea',
      inputLabel: 'Approval Remarks (Optional)',
      inputPlaceholder: 'Enter any remarks or comments...',
      showCancelButton: true,
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Approve',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        // Direct approval with remarks
        approveBatch(batchId, result.value);
      }
    });
  });

  // Submit to Section Button Handler
  $('.submit-to-section-btn').click(function () {
    const batchId = $(this).data('batch-id');
    const batchName = $(this).data('batch-name');

    Swal.fire({
      title: 'Submit to Section Head QA?',
      text: `Do you want to submit batch "${batchName}" to Section Head QA for review?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#007bff',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Submit',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        submitToSection(batchId);
      }
    });
  });

  // Reject Batch Button Handler - Direct rejection with reason
  $('.reject-batch-btn').click(function () {
    const batchId = $(this).data('batch-id');
    const batchName = $(this).data('batch-name');

    Swal.fire({
      title: 'Reject Product Batch?',
      text: `Do you want to reject batch "${batchName}"?`,
      icon: 'warning',
      input: 'textarea',
      inputLabel: 'Rejection Reason (Required)',
      inputPlaceholder: 'Please provide a reason for rejection...',
      inputValidator: (value) => {
        if (!value || value.trim() === '') {
          return 'Rejection reason is required!';
        }
      },
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Reject',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        // Direct rejection with reason
        rejectBatch(batchId, result.value);
      }
    });
  });

  // Submit to Division Button Handler
  $('.submit-to-division-btn').click(function () {
    const batchId = $(this).data('batch-id');
    const batchName = $(this).data('batch-name');

    Swal.fire({
      title: 'Submit to Division Head QA?',
      text: `Do you want to submit batch "${batchName}" to Division Head QA for final approval?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#007bff',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, Submit',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        submitToDivision(batchId);
      }
    });
  });



  // QAR Report Download function
  function downloadQARReport(batchId) {
    // Show loading state
    Swal.fire({
      title: 'Preparing QAR Report...',
      text: 'Please wait while we generate your report.',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Make AJAX call to download QAR report
    $.ajax({
      url: `/product/product-batch/${batchId}/qar-report/`,
      type: 'GET',
      success: function (data, status, xhr) {
        // Hide loading
        Swal.close();
        
        // Create download link for text file
        const blob = new Blob([data], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Get filename from response headers or use default
        const filename = xhr.getResponseHeader('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || `QAR_Report_Batch_${batchId}.txt`;
        a.download = filename;
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        Swal.fire('Success!', 'QAR Report downloaded successfully.', 'success');
      },
      error: function (xhr) {
        Swal.close();
        
        let errorMessage = 'Failed to download QAR report.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMessage = xhr.responseJSON.message;
        }
        
        Swal.fire('Download Error', errorMessage, 'error');
      }
    });
  }

  // Simple toast function
  function showToast(type, message) {
      alert(message); 
  }
});
</script>



{% endblock %}