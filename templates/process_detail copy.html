{% extends 'index.html' %}
{% block content %}
{% load static %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Process Detail - {{ process.process_title }}</h4>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5>Process Steps</h5>
                <table class="table datanew">
                    <thead>
                        <tr>
                            <th>Step ID</th>
                            <th>Description</th>
                            <th>Raw Materials</th>
                            <th>R M Status</th>
                            <th>Equipment</th>
                            <th>Equipment Status</th>
                            <th>Consumable</th>
                            <th>Component</th>
                            <th>Specification</th>
                            <th>Test Value</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for step in process %}
                        <tr>
                            <td>{{ step.step_id }}</td>
                            <td>{{ step.process_description }}</td>
                            <td>{% for material in step.raw_material.all %} {{ material.name }} {% endfor %}</td>
                            <td>{{ step.rm_status }}</td>
                            <td>{% for equip in step.equipment.all %} {{ equip.name }} {% endfor %}</td>
                            <td>{{ step.equipment_status }}</td>
                            <td>{% for consum in step.consumable.all %} {{ consum.name }} {% endfor %}</td>
                            <td>{% for comp in step.component.all %} {{ comp.name }} {% endfor %}</td>
                            <td>{{ step.process_step_spec }}</td>
                            <td>{{ step.measured_value_observation }}</td>
                            <td>{{ step.remarks }}</td>
                            <td>
                                <a class="me-3 view-user-btn" data-bs-toggle="modal" data-bs-target="#materialpage" data-batch-id="{{ batch.id }}">
                                    <img src="{% static 'assets/img/icons/edit.svg' %}" alt="img">
                                </a>
                                <!-- <a id="delete-btn" data-id="{{ batch.id }}" href="javascript:void(0);">
                                    <img src="{% static 'assets/img/icons/delete.svg' %}" alt="img">
                               </a> -->
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Updating Process Step -->
<div class="modal fade" id="updateProcessStepModal" tabindex="-1" aria-labelledby="updateProcessStepModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateProcessStepModalLabel">Update Process Step</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateProcessStepForm" class="row">
                    <input type="hidden" id="step_id" name="step_id" value="">

                    <div class="col-6 mt-2">
                        <label for="process_description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="process_description" name="process_description" placeholder="Description">
                    </div>

                    <div class="col-6 mt-2">
                        <label for="raw_materials" class="form-label">Raw Materials</label>
                        <select class="select" id="raw_materials" name="raw_materials[]" multiple>
                            {% for material in all_raw_materials %}
                                <option value="{{ material.id }}">{{ material.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-6 mt-2">
                        <label for="rm_status" class="form-label">Raw Material Status</label>
                        <input type="text" class="form-control" id="rm_status" name="rm_status" placeholder="Raw Material Status">
                    </div>

                    <div class="col-6 mt-2">
                        <label for="equipment" class="form-label">Equipment</label>
                        <select class="select" id="equipment" name="equipment[]" multiple>
                            {% for equip in all_equipment %}
                                <option value="{{ equip.id }}">{{ equip.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-6 mt-2">
                        <label for="equipment_status" class="form-label">Equipment Status</label>
                        <input type="text" class="form-control" id="equipment_status" name="equipment_status" placeholder="Equipment Status">
                    </div>

                    <div class="col-6 mt-2">
                        <label for="consumables" class="form-label">Consumables</label>
                        <select class="select" id="consumables" name="consumables[]" multiple>
                            {% for consumable in all_consumables %}
                                <option value="{{ consumable.id }}">{{ consumable.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-6 mt-2">
                        <label for="components" class="form-label">Components</label>
                        <select class="select" id="components" name="components[]" multiple>
                            {% for component in all_components %}
                                <option value="{{ component.id }}">{{ component.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-6 mt-2">
                        <label for="process_step_spec" class="form-label">Specifications</label>
                        <input type="text" class="form-control" id="process_step_spec" name="process_step_spec" placeholder="Specifications">
                    </div>

                    <div class="col-6 mt-2">
                        <label for="measured_value_observation" class="form-label">Test Value</label>
                        <input type="text" class="form-control" id="measured_value_observation" name="measured_value_observation" placeholder="Test Value">
                    </div>

                    <div class="col-6 mt-2">
                        <label for="remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="Remarks"></textarea>
                    </div>

                    <div class="d-flex justify-content-center mt-3">
                        <button type="button" class="btn btn-primary btn-sm" id="updateProcessStep">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




<!-- DELETE CONFIRMATION MODAL -->
<div id="confirmDeleteModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center ">
                <p>Are you sure you want to delete this Process?</p>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-danger text-right" id="confirm-delete">Delete</button>
                <button type="button" class="btn btn-secondary text-right" id="cancel-delete"
                    data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    $('#add-raw-material').click(function (event) {
        event.preventDefault(); 
        window.location.href = "{% url 'raw-material-add' %}";
    });

    function populateSourceDropdown(all_sources, selectedSources) {
        const sourceSelect = $('#sources');
        sourceSelect.empty(); 
        all_sources.forEach(source => {
            sourceSelect.append(`<option value="${source.id}">${source.name}</option>`);
        });
        selectedSources.forEach(sourceId => {
            $(`#sources option[value="${sourceId}"]`).prop('selected', true);
        });
        sourceSelect.trigger('change');
    }

    function populateSuppliersDropdown(all_suppliers, selectedSuppliers) {
        const supplierSelect = $('#suppliers');
        supplierSelect.empty(); 
        all_suppliers.forEach(supplier => {
            supplierSelect.append(`<option value="${supplier.id}">${supplier.name}</option>`);
        });
        selectedSuppliers.forEach(supplierId => {
            $(`#suppliers option[value="${supplierId}"]`).prop('selected', true);
        });
        supplierSelect.trigger('change');
    }

    function populateGradeDropdown(all_grades, selectedGrades) {
        const gradeSelect = $('#grade');
        gradeSelect.empty(); 
        all_grades.forEach(grade => {
            gradeSelect.append(`<option value="${grade.id}">${grade.name}</option>`);
        });
        selectedGrades.forEach(gradeId => {
            $(`#grade option[value="${gradeId}"]`).prop('selected', true);
        });
        gradeSelect.trigger('change');
    }
    function populateAcceptanceDropdown(all_acceptance_tests, selectedAcceptanceTests) {
    const acceptanceSelect = $('#acceptance');
    acceptanceSelect.empty(); 
    all_acceptance_tests.forEach(test => {
        acceptanceSelect.append(`<option value="${test.id}">${test.name}</option>`);
    });
    selectedAcceptanceTests.forEach(testId => {
        $(`#acceptance option[value="${testId}"]`).prop('selected', true);
    });
    acceptanceSelect.trigger('change');
}

    $('.view-user-btn').on('click', function () {
        $('#saveUserChanges').show();
        const baseUrl = '/product/raw-material/';
        const batchId = $(this).data('batch-id'); 
        const rawmaterialUpdateUrl = `${baseUrl}${batchId}/`; 

        $.ajax({
            type: 'GET',
            url: rawmaterialUpdateUrl,
            success: function (response) {
                const rawData = response.data;
                $('#raw-material').val(rawData.name);
                $('#shelf_life').val(rawData.shelf_life_value);
                $('#unit').val(rawData.shelf_life_unit);
                $('#raw_material_id').val(rawData.id);

                populateSourceDropdown(rawData.all_sources, rawData.sources.map(source => source.id));
                populateSuppliersDropdown(rawData.all_suppliers, rawData.suppliers.map(supplier => supplier.id));
                populateGradeDropdown(rawData.all_grades, rawData.grades.map(grade => grade.id));
                populateAcceptanceDropdown(rawData.all_acceptance_tests, rawData.acceptance_test.map(test => test.id)); 
               
                $('#materialpage').modal('show');
            },
            error: function (error) {
                console.error('Failed to fetch raw material data:', error);
            }
        });
    });

    $(document).ready(function () {
        $('#updateRawMaterial').click(function (event) {
            event.preventDefault();

            var rawMaterialId = $('#raw_material_id').val();
            var name = $('#raw-material').val();
            var grades = Array.from(document.getElementById('grade').selectedOptions).map(option => Number(option.value)) || [];
            var shelf_life_value = parseInt($('#shelf_life').val(), 10);
            var shelf_life_unit = $('#unit').val();
            var sources = Array.from(document.getElementById('sources').selectedOptions).map(option => Number(option.value)) || [];
            var suppliers = Array.from(document.getElementById('suppliers').selectedOptions).map(option => Number(option.value)) || [];

            const rawMaterialData = {
                'name': name,
                'grades': grades,
                'shelf_life_value': shelf_life_value,
                'shelf_life_unit': shelf_life_unit,
                'sources': sources,
                'suppliers': suppliers,
            };

            $.ajax({
                type: 'PUT',
                url: '/process/edit/' + rawMaterialId + '/',
                data: JSON.stringify(rawMaterialData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.isSuccess) {
                        window.location.href = "/success-page/";
                    } else {
                        $('#error-message').text(response.message).show();
                    }
                },
                error: function () {
                    $('#error-message').text('An error occurred. Please try again.').show();
                }
            });
        });
    });


    $(document).on('click', '#delete-btn', function (e) {
        e.preventDefault(); // Prevent default link behavior

        var rawId = $(this).data('id'); // Get RAW MATERIAL ID from data attribute
        if (!rawId) {
            alert('Raw Material ID not found.');
            return;
        }

        // Store the RAW MATERIAL in the modal's confirm button for reference
        $('#confirm-delete').data('id', rawId);

        // Show the confirmation modal
        $('#confirmDeleteModal').modal('show');
    });

    // Handle the confirmation of deletion
    $(document).on('click', '#confirm-delete', function () {
        var rawId = $(this).data('id'); // Retrieve MATERIAL ID from the modal's confirm button

        if (!rawId) {
            alert('Material ID not found.');
            return;
        }

        // Construct the URL dynamically
        const baseUrl = "/product/raw-material/delete/";
        const deleteUrl = `${baseUrl}${rawId}/`;

        // Perform the AJAX request for deletion
        $.ajax({
            url: deleteUrl,
            type: 'POST',
            data: JSON.stringify({ 'rawId': rawId }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}', // Add CSRF token header
            },
            success: function (response) {
                if (response.success) {
                    console.log('Delete successful, reloading page...');

                    // Close the modal after success
                    $('#confirmDeleteModal').modal('hide');

                    // Reload the page immediately after successful deletion
                    window.location.reload(true); // Force reload (bypass cache)
                } else {
                    alert('Error: ' + response.message);
                    console.error('Delete failed: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                alert('An error occurred: ' + error);
                console.error('AJAX error:', error);
            }
        });
    });

    // Handle the cancel button to close the modal
    $(document).on('click', '#cancel-delete, .close', function () {
        $('#confirmDeleteModal').modal('hide'); // Explicitly hide the modal on cancel
    });

</script>
{% endblock %}