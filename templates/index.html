<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <meta name="description" content="POS - Bootstrap Admin Template">
    <meta name="keywords"
        content="admin, estimates, bootstrap, business, corporate, creative, management, minimal, modern,  html5, responsive">
    <meta name="author" content="Dreamguys - Bootstrap Admin Template">
    <meta name="robots" content="noindex, nofollow">
    {% load static %}

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUa1zYzBSlzLlNZOSfBu4cuZX3PB1z7xO1pqb4hlrjjoC1lzI3LOWjBlBi8M" crossorigin="anonymous">

    <!-- jQuery (required for Select2) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/favicon.png' %}">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.min.css' %}">

    <!-- animation CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/animate.css' %}">

    <!-- Datatable CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/dataTables.bootstrap4.min.css' %}">

    <!-- Select2 CSS -->
    <link rel="stylesheet" href="{% static 'assets/plugins/select2/css/select2.min.css' %}">

    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome/css/fontawesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome/css/all.min.css' %}">

    <!-- Main CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/style2.css' %}">

    <!-- Alert CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/alert.css' %}">

    <!-- Include Select2 CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


</head>

<body>
    <div id="global-loader">
        <div class="whirly-loader"> </div>
    </div>
    <!-- Main Wrapper -->
    <div class="main-wrapper">

        <!-- Header -->
        <div class="header">

            <!-- Logo -->
            <div class="header-left active">
                <a href="index.html" class="logo logo-normal">
                    <img src="{% static 'assets/img/neww.png' %}" alt="">
                </a>
                <a href="index.html" class="logo logo-white">
                    <img src="{% static 'assets/img/logo-white.png' %}" alt="">
                </a>
                <a href="index.html" class="logo-small">
                    <img src="{% static 'assets/img/logo-small.png' %}" alt="">
                </a>
                <a id="toggle_btn" href="javascript:void(0);">
                    <i data-feather="chevrons-left" class="feather-16"></i>
                </a>
            </div>
            <!-- /Logo -->

            <a id="mobile_btn" class="mobile_btn" href="#sidebar">
                <span class="bar-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </a>

            <!-- Header Menu -->
            <ul class="nav user-menu">

                <!-- Search -->
                <li class="nav-item nav-searchinputs">
                    <div class="top-nav-search">

                        <a href="javascript:void(0);" class="responsive-search">
                            <i class="fa fa-search"></i>
                        </a>
                        <form action="#">
                            <div class="searchinputs">
                                <input type="text" placeholder="Search">
                                <div class="search-addon">
                                    <span><i data-feather="search" class="feather-14"></i></span>
                                </div>
                            </div>
                            <!-- <a class="btn"  id="searchdiv"><img src="assets/img/icons/search.svg" alt="img"></a> -->
                        </form>
                    </div>
                </li>
                <!-- /Search -->

                <!-- Flag -->
                <li class="nav-item dropdown has-arrow flag-nav nav-item-box">
                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="javascript:void(0);"
                        role="button">
                        <i data-feather="globe"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a href="javascript:void(0);" class="dropdown-item active">
                            <img src="{% static 'assets/img/flags/us.png' %}" alt="" height="16"> English
                        </a>
                        <a href="javascript:void(0);" class="dropdown-item">
                            <img src="{% static 'assets/img/flags/fr.png' %}" alt="" height="16"> French
                        </a>
                        <a href="javascript:void(0);" class="dropdown-item">
                            <img src="{% static 'assets/img/flags/es.png' %}" alt="" height="16"> Spanish
                        </a>
                        <a href="javascript:void(0);" class="dropdown-item">
                            <img src="{% static 'assets/img/flags/de.png' %}" alt="" height="16"> German
                        </a>
                    </div>
                </li>
                <!-- /Flag -->

                <li class="nav-item nav-item-box">
                    <a href="javascript:void(0);" id="btnFullscreen">
                        <i data-feather="maximize"></i>
                    </a>
                </li>
                <li class="nav-item nav-item-box">
                    <a href="email.html">
                        <i data-feather="mail"></i>
                        <span class="badge rounded-pill">1</span>
                    </a>
                </li>
                <!-- Notifications -->
                <li class="nav-item dropdown nav-item-box">
                    <a href="javascript:void(0);" class="dropdown-toggle nav-link" data-bs-toggle="dropdown">
                        <i data-feather="bell"></i>
                        <span class="badge rounded-pill" id="notification-count">{{ unread_count }}</span>
                        <!-- Show unread count -->
                    </a>
                    <div class="dropdown-menu notifications">
                        <div class="topnav-dropdown-header">
                            <span class="notification-title">Notifications</span>
                            <a href="javascript:void(0)" class="clear-noti"> Clear All </a>
                        </div>
                        <div class="noti-content">
                            <ul class="notification-list">
                                {% for notification in notifications %}
                                <li class="notification-message">
                                    <a href="javascript:void(0);" onclick="markNotificationAsRead({{ notification.id }})">
                                        <div class="media d-flex">
                                        <div class="media d-flex">
                                            <span class="avatar flex-shrink-0">
                                                <img alt="" src="{% static 'assets/img/profiles/avatar-02.jpg' %}">
                                            </span>
                                            <div class="media-body flex-grow-1">
                                                <p class="noti-details">
                                                    <span class="noti-title">{{ notification.message }}</span>
                                                </p>
                                                <p class="noti-time">
                                                    <span class="notification-time">{{ notification.created_at|timesince
                                                        }} ago</span>
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                {% empty %}
                                <li class="notification-message">
                                    <div class="media d-flex">
                                        <div class="media-body flex-grow-1">
                                            <p class="noti-details">
                                                <span class="noti-title">No new notifications</span>
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="topnav-dropdown-footer">
                            <a href="{% url 'view_all_notifications' %}">View all Notifications</a>
                        </div>
                    </div>
                </li>
                <!-- /Notifications -->

                <li class="nav-item nav-item-box">
                    <a href="generalsettings.html"><i data-feather="settings"></i></a>
                </li>
                <li class="nav-item dropdown has-arrow main-drop">
                    <a href="javascript:void(0);" class="dropdown-toggle nav-link userset" data-bs-toggle="dropdown">
                        <span class="user-info">
                            <span class="user-letter">
                                <img src="{% static 'assets/img/profiles/download.jpg' %}" alt="" class="img-fluid">
                            </span>
                            <span class="user-detail">
                                <span class="user-detail">
                                    <span class="user-name">{{ user.username }}</span>
                                    <span class="user-role"> 
                                        {% for role in user.role.all %}
                                          {{ role.name }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        No Role Assigned
                                    {% endfor %}
                                </span>
                                </span>

                            </span>
                        </span>
                    </a>
                    <div class="dropdown-menu menu-drop-user">
                        <div class="profilename">
                            <div class="profileset">
                                <span class="user-img"><img src="{% static 'assets/img/profiles/download.jpg' %}" alt="">
                                    <span class="status online"></span></span>
                                <div class="profilesets">
                                    <div class="profilesets">
                                        <h6>{{ user.username }}</h6>
                                        <h5>{% for role in user.role.all %}
                                            {{ role.name }}{% if not forloop.last %}, {% endif %}
                                        {% empty %}
                                            No Role Assigned
                                        {% endfor %}    </h5>
                                    </div>
                                </div>
                            </div>
                            <hr class="m-0">
                            <a class="dropdown-item" href="profile.html"> <i class="me-2" data-feather="user"></i> My
                                Profile</a>
                            <a class="dropdown-item" href="generalsettings.html"><i class="me-2"
                                    data-feather="settings"></i>Settings</a>
                            <hr class="m-0">
                            <a class="dropdown-item logout pb-0" id="log-out" href="#">
                                <img src="{% static 'assets/img/icons/log-out.svg' %}" class="me-2" alt="img">Logout
                            </a>

                        </div>
                    </div>
                </li>
            </ul>
            <!-- /Header Menu -->

            <!-- Mobile Menu -->
            <div class="dropdown mobile-user-menu">
                <a href="javascript:void(0);" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"
                    aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="profile.html">My Profile</a>
                    <a class="dropdown-item" href="generalsettings.html">Settings</a>
                    <a class="dropdown-item logout pb-0" id="log-out">
                        <img src="{% static 'assets/img/icons/log-out.svg' %}" href="{% url 'logout_view' %}"
                            class="me-2" alt="img">Logout
                    </a>
                </div>
            </div>
            <!-- /Mobile Menu -->
        </div>
        <!-- Header -->

        <!-- Sidebar -->

        {% include 'sidebar.html' %}

        <!-- /Sidebar -->

        {% block content %}
        {% endblock %}

        <!-- JS Libraries -->

        <!-- jQuery (required for Select2) -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- Popper.js -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>

        <!-- Bootstrap Core JS -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>
        <script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>

        <!-- Feather Icon JS -->
        <script src="{% static 'assets/js/feather.min.js' %}"></script>

        <!-- Slimscroll JS -->
        <script src="{% static 'assets/js/jquery.slimscroll.min.js' %}"></script>

        <!-- Datatable JS -->
        <script src="{% static 'assets/js/jquery.dataTables.min.js' %}"></script>
        <script src="{% static 'assets/js/dataTables.bootstrap4.min.js' %}"></script>

        <!-- Select2 JS -->
        <script src="{% static 'assets/plugins/select2/js/select2.min.js' %}"></script>

        <!-- Sweetalert 2 -->
        <script src="{% static 'assets/plugins/sweetalert/sweetalert2.all.min.js' %}"></script>
        <script src="{% static 'assets/plugins/sweetalert/sweetalerts.min.js' %}"></script>

        <!-- Apexcharts -->
        <script src="{% static 'assets/plugins/apexchart/apexcharts.min.js' %}"></script>
        <script src="{% static 'assets/plugins/apexchart/chart-data.js' %}"></script>

        <!-- Custom JS -->
        <script src="{% static 'assets/js/script.js' %}"></script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-w76AqxarZxrWEsBhDbE6z3nmKaLQ0fvbXtKp752kRr9i9dtK5vf5RkM2R5iJoKtu"
            crossorigin="anonymous"></script>

        <div id="alertBox" class="alert"></div>


</body>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('log-out').addEventListener('click', function (event) {
            event.preventDefault(); // Prevent the default anchor behavior
            // Use the Django URL template tag to get the URL for login_view
            window.location.href = '{% url "login_view" %}';
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === name + '=') {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('log-out').addEventListener('click', function (e) {
        e.preventDefault(); // Prevent default link behavior

        fetch('/logout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // CSRF token for security
            },
        })
            .then(response => {
                if (response.ok) {
                    // Redirect or show success message
                    window.location.href = '/login/';
                } else {
                    console.error('Logout failed:', response);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });



    function showAlert(message, type) {
        let alertBox = $('#alertBox');
        alertBox.text(message).removeClass('success error').addClass(type).fadeIn();
        setTimeout(function () {
            alertBox.fadeOut();
        }, 2700); // Disappear after 3 seconds
    }

    //for userprofile
    $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: "user-profile/",  // API endpoint
             dataType: "json",
            success: function(data) {
                $("#user-name").text(data.username); // Update UI with username
                $("#user-role").text(data.name); // Update UI with username
            },
            error: function() {
                $("#user-name").text("User not found");
                $("#user-role").text("User not found");
            }
        });
    });


    $(document).ready(function () {
        $('#successBtn').click(function () {
            showAlert('Data submitted successfully!', 'success');
        });

        $('#errorBtn').click(function () {
            showAlert('Data submission failed!', 'error');
        });
    });


    function markNotificationAsRead(notificationId) {
    console.log('Marking notification as read: ' + notificationId); // Debugging

    fetch(`/notifications/mark_as_read/${notificationId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'), // Ensure CSRF token is included
        },
    })
        .then(response => {
            if (response.ok) {
                console.log('Notification marked as read successfully'); // Debugging

                // Decrease the notification count
                const notificationCount = document.getElementById('notification-count');
                let count = parseInt(notificationCount.textContent);
                if (count > 0) {
                    count -= 1;
                    notificationCount.textContent = count;
                }

                // Optionally, remove the notification from the dropdown
                const notificationElement = document.querySelector(`li.notification-message a[onclick*="${notificationId}"]`);
                if (notificationElement) {
                    notificationElement.closest('li').remove();
                }

                // If no notifications are left, show a message
                if (count === 0) {
                    const notificationList = document.querySelector('.notification-list');
                    notificationList.innerHTML = `
                        <li class="notification-message">
                            <div class="media d-flex">
                                <div class="media-body flex-grow-1">
                                    <p class="noti-details">
                                        <span class="noti-title">No new notifications</span>
                                    </p>
                                </div>
                            </div>
                        </li>
                    `;
                }
            } else {
                console.error('Failed to mark notification as read:', response.statusText);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}


</script>

{% block scripts %} {% endblock %}

</html>